<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>AI</title>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1250">
<link type="text/css" href="mainstyles.css" rel="stylesheet">
</head>
<body>

<h1><a name="sec4">4 Umìlá inteligence</a></h1>
<p>
Cílem AI (<i>Artificial Intelligence - Umìlá Inteligence</i>) je vytvoøit umìlého "øidièe", kterı bude dùstojnım soupeøem hráèi hry Unlimited Racer. Automobil øízenı pomocí AI by mìl bıt schopen jezdit rozumnou rychlostí po trati, pøes pøekáky a vyhıbat se protivníkùm. Je nutné poznamenat, e prakticky neexistuje dostupná literatura, která by se tímto problémem zabıvala. Bìné metody pouívané v oboru Umìlé Inteligence jsou pro potøeby poèítaèovıch her zpravidla nepouitelné, zpravidla pro svou vıpoèetní nároènost, nebo nutnost "pøedpoèítávání dat". Èastokrát nemají ani moc pouitelné vısledky. Takto jsme napøíklad narazili s pùvodní myšlenkou, jak implementovat AI. Ta poèítala s vyuítím technik zpìtnovazebného uèení (Reinforcement Learning). Po bliším prozkoumání se tato metoda ukázala bıt velmi nevhodná, zejména z dùvodù velké volnosti našeho svìta, nutnosti "nauèit" algoritmus pøedem, nedostateèné schopnosti reagovat na dynamicky se mìnící situaci a v neposlední øadì také díky vıpoèetní nároènosti.<br>
Ve finální verzi je pouitá modifikace metody známé jako <a href="http://www.red3d.com/cwr/steer/" target="_blank">Steering</a>, zejména pak variant <a href="http://www.red3d.com/cwr/steer/PathFollow.html" target="_blank">Path Following</a> a <a href="http://www.red3d.com/cwr/steer/Obstacle.html" target="_blank">Obstacle Avoidance</a> pro pohybující se objekty. Metoda je vıpoèetnì nenároèná, nepøedpokládá ádná pøedpoèítaná data a tak se velmi hodí pro pouití v dynamické poèítaèové høe.<br><br> Implementace pøedpokládala pouití projektu <a href="http://opensteer.sourceforge.net/">OpenSteer</a>, kterı obsahuje ji hotovou implementaci zmíòìnıch algoritmù. Nakonec se tak ale nestalo, pøevánì z tìchto dùvodù:
<ul><li>
Implementace OpenSteeru nedovoluje jednoduše oddìlit vıpoèetní èást (OpenSteer) od èásti zobrazovací (OpenSteerDemo) a implementace pokroèilejších algoritmù je vıhradì ve formì pluginù pro OpenSteerDemo. OpenSteer je navren opaènì ne bychom chtìli - umoòuje pøidávání pluginù a jejich jednoduché zobrazování, ale díky provázanosti projektù neumoòuje implementované algoritmy pouít v jiném produktu (Unlimited Racer) bez jejich kompletního pøepsání.
</li><br>
<li>
OpenSteer má velmi zjednodušenı pohled na svìt a autonomní objekty v nìm se pohybující. Øada tìchto zjednodušení se pro automobilovı simulátor nehodí, nebo je dokonce konstrukèní vadou - napøíklad se pøedpokládá, e jakıkoliv objekt je automaticky natoèenı podle smìru svého pohybu a mùe se otoèit na místì pøi nulové rychlosti. To samoøejmì bìnı automobil neumí.
</li>
</ul>
Nakonec tedy nezbylo ne prostudovat algoritmy pouité v OpenSteeru, zejména pak plugin "Pedestrian" a kompletnì je pøepsat, aby vyhovovaly našim poadavkùm. Moná zde není vhodné mluvit o pøepsání OpenSteeru, ale spíš o inspiraci OpenSteerem, protoe po postupném pøepisování a upravování z OpenSteeru zbylo jen logické rozdìlení do tøíd a hiearchickı model volání funkcí. Vìtšinu ostatního kódu bylo potøeba zjednodušit, vynechat èi pøepsat tak, aby vyhovoval našim poadavkùm.<br>
</p> <br>

<p class="center"><img src="images/AI_scheme.gif"></p>
<p class="center"><strong>Obrázek 4.1: Schéma umístìní modulu AI v projektu.</strong></p>
<p>

<h2><a name="sec4.1">4.1 Základní princip fungování AI</a></h2>
<p>AI vyuívá waypointù, pomocí kterıch je popsána tra, kterou má auto projet. Tyto waypointy jsou pøedgenerovány pomocí Limited Editoru. Auta ovládaná pomocí AI se snaí waypointù dret a souèasnì (s niší prioritou) se vyhıbat ostatním dynamickım objektùm (jejich hmotnost pøekroèí jistou hranici). Kadı waypoint má navíc nastavenou minimální a maximální rychlost, kterou se pøes nìj dá jet. Pøi vhodném nastavení tak AI pozná, e má do zatáèky zpomalit a naopak na rovince jet rychle. AI ignoruje statické objekty (napøíklad lampy podél trati, billboardy), protoe je díky implementaci fyziky nelze nijak odlišit od vlastních objektù pøekáek (looping, rampa, ...). Pokud se auto øízené AI v urèitém èasovém intervalu nepohne o pøedem definovanı poèet metrù, je restartováno. Toto restartování je zde pro pøípad, kdy automobil uvízne v pøekáce èi jiném objektu a nedokáe odtud vyjet. Hráè má k dispozici podobnou funkci.<br>
<br><br>
<p class="center"><img src="images/AIClasses.gif"></p>
<p class="center"><strong>Obrázek 4.2: Schéma tøíd v AI.</strong></p><br>
<h2><a name="sec4.2">4.2 CSteeringAI</a></h2>
<p>
	<code>CSteeringAI</code> je hlavní tøída projektu AI, která slouí jako rozhraní pro komunikaci s dalšími èástmi Unlimited Raceru. Tato tøída zajišuje inicializaci celé AI, synchronizaci pozic a rychlostí objektù pøed vlastním vıpoètem a nastavení ovládacích prvkù aut po vıpoètu.
	Samotná incializace se pak provádí pøedáním inicializaèní struktury <code>InitStruct</code> funkci <code>InitAI()</code>. V prùbìhu inicializace si tato funkce naète mapu a najde optimální posloupnost waypointù, které odpovídají cestì zvolené Limited Editoru. Optimální cesta se hledá pomocí Dijkstrova algoritmu v grafu s kladnì ohodnocenımi hranami. Vrcholy grafu jsou jednotlivé sady waypointù pøíslušející k políèkùm, pøes které vede tra. Mezi dvìma vrcholy (v1 a v2) vede cesta s ohodnocením H, pokud spolu na trati (vygenerované v Limited Editoru) sousedí políèka pøíslušející sadám waypointù rerezentovanıch vrcholy v1 a v2. H je potom rovno vzdálenosti koneèného waypointu sady v1 a poèáteèního vrcholu sady v2. Díky tomu je moné pomìrnì rychle sloit ze sad waypointù cestu, která má minimální souèet vzdáleností mezi sadami waypointù. Po lomené èáøe definované tìmito waypointy poté jezdí auta øízená pomocí AI. U waypointù je tøeba spoèítat a uloit absolutní pozice, protoe v mapì uloené waypointy mají relativní pozice vùèi políèku, na kterém se nacházejí. Vısledkem je tedy posloupnost waypointù ve svìtovıch souøadnicích. Tuto posloupnost potøebuje ke svému fungování tøída <a href="#sec4.2.3.2"><code>CAIPath</code></a>. Podrobnìjší popis uloení trati a waypointù lze najít v <a href="FileSystem.html#Urmap">dokumentaci k souboru typu .urmap</a>. <code>InitAI()</code> také inicializuje všechna auta (<a href="#sec4.2.3.4"><code>CAIVehicle</code></a>) a ostatní dynamické objekty (<a href="#sec4.2.3.3"><code>CAIObject</code></a>) pøíslušné mapy.
</p>
<p>
	Hlavní úkol AI, tedy øízení poèítaèovıch aut, se spouští zavoláním funkce <code>Update()</code>. Funkce <code>Update()</code> je volána z projektu <strong>Server</strong> po té, co je spoèítána fyzika. Ve funkci <code>Update()</code> AI aktualizuje pozice a rychlosti všech objektù na mapì. Poté pro kadé auto ovládané pomocí AI zavolá <a href=""><code>CAIVehicle::Update()</code></a>. Tato funkce spoèítá bod, ke kterému se automobil má snait jet spolu s jeho doporuèenou minimální a maximální rychlostí. Funkce <code>SaveCar()</code> následnì nastaví odpovídajícím zpùsobem ovládací prvky auta: natoèí kola poadovanım smìrem a zrychlí/zpomalí/brzdí dle potøeby.
	</p>
<br>
<h2><a name="sec4.3">4.3 CAIPath</a></h2>
<p>
Tøída <code>CAIPath</code>reprezentuje tra, po které auta jedou. Pouívá k tomu posloupnost waypointù, kolem kterıch se auta øízená AI snaí jezdit. Celá tra je tedy zjednodušena na lomenou èáru, která vznikne spojením za sebou jdoucích waypointù. <code>CAIPath</code> obsahuje funkce pro "namapování" libovolného bodu na mapì k nejblišímu bodu na trati, mapování ujeté vzdálenosti k bodu na trati, zjištìní vzdálenosti bodu od trati a další. Tyto funkce pouívá pøevánì tøída <code>CAIVehicle</code> pro urèení smìru a rychlosti jízdy poèítaèem øízeného automobilu.
</p>
<br>
<h2><a name="sec4.4">4.4 CAIObject</a></h2>
<p>
Tøída <code>CAIObject</code> se pouívá k reprezentaci libovolného dynamického objektu umístìného na mapì. Pro zjednodušení se pøedpokládá, e jakıkoliv objekt je koule s danım støedem, polomìrem, hmotností a vektorem rychlosti. Aproximace koulí je zvolena zejména pro jednoduchost vıpoètu testu kolize objektù. Nepøesnost této aproximace není pro AI (narozdíl od fyziky) pøíliš dùleitá, ale pøesto je dobré nepouívat na mapì dynamické objekty, které jsou vıraznì delší v jednom smìru. AI se jim potom bude vyhıbat zbyteènì velkım obloukem. Zøejmì by bylo moné implementovat jinou formu reprezentace objektu na mapì, která by nemìla tyto problémy. Po peèlivém zváení všech pro a proti jsme dospìli k názoru, e je to zbyteèné a dokonce neádoucí. Jakákoliv jiná reprezentace by sice zlepšila pøesnost detekce kolizí, ale zároveò by o mnoho zesloitila jejich vıpoèet. AI by poté mohla o nìco lépe uhıbat pøed pøekákami, ale vısledek by byl témìø neznatelnı, narozdíl od zmìny rychlosti vıpoètu, která je v poèítaèové høe jedním z hlavních kritérií pouitelnosti algoritmu. Pouitá metoda je tak i pøes své neduhy zøejmì nejlepší metodou, kterou lze pouít.
</p>
<br>
<h2><a name="sec4.5">4.5 CAIVehicle</a></h2>
<p>
	Tøída <code>CAIVehicle</code> je potomkem tøídy <code>CAIObject</code>. Abstrakce dynamického objektu pouitá ve tøídì <code>CAIObject</code> nestaèí pro reprezentaci automobilu, proto obsahuje <code>CAIVehicle</code> navíc nìkolik dalších informací. Jsou to zejména informace slouící k urèení aktuálního umístìní v závodu, ji projeté èásti trati, doporuèené rychlosti a testu, zda je potøeba vozidlo restartovat. <br>
	Navíc tato tøída obsahuje nìkolik funkcí dùleitıch k urèení, kam má automobil øízenı pomocí AI jet. Tuto informaci, v podobì bodu, ke kterému se má snait automobil jet, poèítá funkce <code>CombinedSteering()</code>. <code>CombinedSteering()</code> v sobì kombinuje dva rùzné stavy jízdy automobilu: vyhıbání se pøekákám a jízdu podél trati. Hlavní dùraz je kladen na jízdu podél trati, ale s urèitou pravdìpodobností se kontroluje, zda náhodou nehrozí v budoucnosti sráka s jinım objektem. Pokud je taková sráka detekována, pouije se jako vısledek návratová hodnota funkce <code>SteerToAvoidObjects()</code>. V opaèném pøípadì se pouije návratová hodnota funkce <code>SteerToFollowPath()</code>.<br>
</p>
	<a name="sec4.5.1"><h3>4.5.1 SteerToAvoidObjects()</h3></a>
<p>
	Tato funkce detekuje monou kolizi objektu. Najde nejbliší hrozící kolizi s jinım dostateènì hmotnım objektem a pokusí se zatoèením této kolizi vyhnout. Cílem není jen se vyhıbat pøi moné kolizi, ale zároveò udrovat jistou minimální vzdálenost od problematickıch objektù.
</p>
	<a name="sec4.5.2"><h3>4.5.2 SteerToFollowPath()</h3></a>
<p>
	Funkce <code>SteerToFollowPath()</code> slouí ke sledování pøedepsané trati. To je pomìrnì obtínı úkol, protoe nemùeme dovolit zkracování trati, ale zároveò chceme dovolit jistou míru volnosti jejího následování. Tento problém se nakonec podaøilo vyøešit <br>Abychom zajistili dobrou jízdu po trati, predikujeme pozici auta po t sekundách (ve skuteènosti se parametr t pohybuje v rozmezí 0.5s - 2s). Pokud je pozice auta dostateènì blízko trati, pokraèujeme v jízdì tímto smìrem. V opaèném pøípadì musíme zatoèit, abychom v budousnocti nevyjeli z trati. Spoèteme kam bychom se pøi ideální jízdì po trati mìli dostat a snaíme se k tomuto bodu smìøovat. To nám definuje smìr naší jízdy. Rychlost je definována pomocí naší aktuální rychlosti a doporuèené minimální a maximální rychlosti pøíslušné k tomuto bodu. Tento princip jízdy je vıpoèetnì pomìrnì jednoduchı a má dobré jízdní vısledky pøi vhodnì zvolenıch parametrech. Správné nastavení velkého mnoství rùznıch parametrù, spolu velmi obtínım realtime ladìním pomocí logù, se však ukázalo bıt jedním z nejvìtších problému pøi programování AI.
</p>
<br>
<h2><a name="sec4.6">4.6 V3</a></h2>
<p>
	<code>V3</code> je tøída reprezentující tøírozmìrnı vektor. Pouívá se v celém projektu AI pro uchování pozic, vekterù rychlosti a dalších údajù. Tøída <code>V3</code> obsahuje mnoho uiteènıch funkcí z analytické geometrie, které zjednodušují vıpoèty potøebné v AI.
</p>
<br>
<br><br>
<p>&nbsp;</p>
<p>&nbsp;</p>
</body>
</html>
