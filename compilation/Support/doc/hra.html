<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=windows-1250">
	<link type="text/css" href="mainstyles.css" rel="stylesheet">
</head>

<body>
<h1><a name="sec5">5 Hra</a></h1>



<h2><a name="sec5.1">5.1 Klient</a></h2>
<h3><a name="sec5.1.1">5.1.1 Úvod</a></h3>
<p>Klientem je kadá jednotlivá koncová stanice hráèù. Klient zajišuje pøedevším komunikaci se serverem a poskytuje ostatním 
  èástem projektu informace, které potøebují vìdìt. Klient je nadøazen 
  grafickému renderovacímu systému, HUDu, hudebnímu systému a nìkterım dalším 
  ménì vıznamnım èástem. Sluby klienta vyuívají zejména dialogy. Sám klient 
  vyuívá slueb resource manageru, konfigurace a dalších èástí poskytujících 
  globální sluby (projekt <strong>Globals</strong>).</p>
<p class="center"><img src="images/ClientPosition.png" width="554" height="445"></p>
<p class="center"><strong>Obrázek 5.1: Postavení klienta vùèi ostatním èástem aplikace</strong></p>
<h3><a name="sec5.1.2">5.1.2 Implementace klienta</a></h3>
<p>Implementace klienta se skládá z následujících èástí:</p>
<ol>
  <li>Tøída <strong>CClient </strong>- je jádrem implementace klienta. Uchovává 
    stav (z mnoiny stavù, do kterıch se klient mùe dostat), ve kterém se klient 
    nachází. Pro kadı stav má funkci, která slouí jako message handler (zpracovatel 
    zpráv) zpráv pøicházejících od serveru, které se pro danı stav nìjakım zpùsobem 
    vyhodnocují. Obsahuje síové sluby, hudbu, HUD, informaèní tøídu <strong>CMultiplayerGameInfo</strong>.</li>
  <li>Síové sluby v podobì tøíd <strong>CNetMsg </strong>a <strong>CNetClient</strong>. 
    Tøída <strong>CNetMsg</strong> implementuje zprávy, které chodí po síti. Tøída<strong>CNetClient</strong> 
    zajišuje pøíjem a posílání zpráv po síti a rozesílání a pøíjem broadcastu.</li>
  <li>HUD (Head-up display) v podobì tøídy <strong>CHUD</strong>, která zajišuje 
    informaèní interface pro hráèe jako je ukazatel rychlosti, tabulka prùbìného poøadí, atd...</li>
  <li>Hudba v podobì tøídy <strong>CSoundSystem</strong>, která zajišuje pøehrávání 
    hudby.</li>
  <li>Informace o jednotlivıch hráèích, podstavech, nastavení konkrétní hry (mapa, 
    auta, atd...), funkcí na nastavení jednotlivıch typù zpráv, funkcí na &quot;rozbalení&quot; 
    jednotlivıch typù zpráv, atd... v podobì tøídy <strong>CMultiplayerGameInfo</strong>.</li>
  <li>Tøídu <strong>CGameInfo</strong>, která zajišuje funkce prohledávání adresáøù 
    pro seznam map, aut a hudby. Zajišuje ukládání, nahrávání a pøístup 
    do traovıch rekordù.</li>
  <li>Soubory <strong>MapInit.h </strong>a <strong>MapInit.cpp</strong>, ve kterıch 
    jsou umístìny funkce pro nahrávání mapy a aut</li>
</ol>
<p class="center"><img src="images/ClientClass.png" width="512" height="447"></p>
<p class="center"><strong>Obrázek 5.2: Jednotlivé souèásti klienta</strong></p>
<h3><a name="sec5.1.3">5.1.3 Jádro klienta - tøída CClient</a></h3>
<p>Klient se mùe nacházet v rùznıch stavech. Podle stavu, ve kterém se nachází, 
  se volá funkce slouící jako message handler a zpracovávající zprávy pøicházející 
  ze serveru. Stav klienta se dá zmìnit voláním funkce <strong>ChangeState()</strong>. 
  Stavy, ve kterıch se klient mùe nacházet, jsou následující:</p>
<ul>
  <li> <strong>CS_NULL - </strong>Základní stav klienta, ve kterém nepøijímá ádné 
    zprávy od serveru</li>
  <li><strong>CS_SG_START - </strong>Stav nahrávání single playeru (hry jednoho 
    hráèe)</li>
  <li><strong>CS_MG_ENUMERATE_HOSTS </strong>- Stav, kdy klient pøijímá a vysílá 
    broadcast, aby se dozvìdìl o dostupnıch herních serverech naší aplikace na 
    lokální síti</li>
  <li><strong>CS_MG_START - </strong>Stav, kdy je klient pøipojen k serveru, hráè 
    si vybírá auto, jméno, chatuje s ostatními hráèi</li>
  <li><strong>CS_MG_START_LOAD</strong> - Stav, kdy se nahrává multi player (hra 
    pro více hráèù)</li>
  <li><strong>CS_GAME_PLAY </strong>- Stav, kdy bìí samotná hra</li>
  <li><strong>CS_RACE_RESULT </strong>- Stav, kdy jsou hráèovi zobrazovány vısledky 
    závodu</li>
</ul>
<p>Funkce <strong>ClientMessageHandler()</strong> podle stavu, ve kterém se klient 
  nachází, zavolá pøíslušnou funkci message handleru, která se postará o vıbìr 
  a zpracování zpráv od serveru. Jedná se o následující funkce:</p>
<ul>
  <li><strong>ClientMultiEnumMH() </strong>pro stav <strong>CS_MG_ENUMERATE_HOSTS</strong></li>
  <li><strong>ClientMultiStartMH() </strong>pro stav <strong>CS_MG_START</strong></li>
  <li><strong>ClientSingleStartMH() </strong>pro stav <strong>CS_SG_START</strong></li>
  <li><strong>ClientGameMH() </strong>pro stav <strong>CS_GAME_PLAY</strong></li>
  <li><strong>ClientMultiStartLoadMH() </strong>pro stav <strong>CS_MG_START_LOAD</strong></li>
  <li><strong>ClientRaceResultsMH()</strong> pro stav <strong>CS_RACE_RESULT</strong></li>
</ul>
<p>Funkce <strong>ClientMessageHandler()</strong> se volá periodicky, aby byl 
  zajištìn plynulı vıbìr zpráv od serveru. Postup komunikace mezi serverem a klientem 
  je popsán dále v dokumentaci klienta.</p>
<p>Tøída <strong>CClient </strong>obsahuje také funkce, které spouští nahrávání 
  hry pro single player i pro multiplayer na stranì klienta. Pro single player 
  se jedná o funkci <strong>ClientStartSingleiLoad()</strong>. Pro multiplayer 
  se jedná o funkci <strong>ClientStartMultiLoad()</strong>. Postup nahrávání 
  mapy a aut je popsán v dokumentaci klienta.</p>
<p>Tøída <strong>CClient</strong> obsahuje:</p>
<ol>
  <li>Tøídu <strong>CHUD</strong> - Head-up display</li>
  <li>Tøídu <strong>CSoundSystem </strong>- hudba</li>
  <li>Tøídu <strong>CNetClient</strong> <strong>- </strong>síová komunikace se 
    serverem </li>
</ol>
<h3><a name="sec5.1.4">5.1.4 Postup nahrávání mapy a auta ze strany klienta</a></h3>
<p>Mapa se nahrává pomocí funkce <strong>MapInit() </strong>implementované v souboru 
  <strong>MapInit.cpp.</strong> Mapa se vdy nahrává pøed nahrátí aut hráèù. Postup nahrávání mapy je následující:</p>
<ol>
  <li><strong>Resource manager </strong>nahraje obsah souboru mapy i s dalšími 
    závislımi soubory na mapì.</li>
  <li>Nahraje se grafická reprezentace terénu v tøídì <strong>CScene</strong> 
    promìnná <strong>Map </strong>- funkce <strong>Init() </strong>tøídy <strong>CGrObjectTerrain</strong>.</li>
  <li>Vytvoøí se zeï kolem celé mapy - funkce <strong>InitBorders()</strong> tøídy 
    <strong>CGrObjectTerrain</strong>.</li>
  <li>Nahraje se tráva - funkce <strong>InitGrass() </strong>implementovaná v 
    souboru <strong>MapInit.cpp</strong>.</li>
  <li>Nahraje se obloha - funkce <strong>Init() </strong>tøídy <strong>CGrObjectSkySystem</strong>.</li>
  <li>Do reprezentace scény se nastaví svìtlo od slunce a ambientní svìtlo.</li>
  <li>Nahrají se jednotlivé objekty na mapì. Kadı objekt se inicializuje pomocí 
    funkce <strong>Init() </strong>tøídy <strong>CGrObjectMesh</strong>. Kadı 
    objekt se správnì natoèí a pøidá buï do seznamu statickıch (<strong>StaticObjects</strong>) 
    nebo dynamickıch (<strong>DynamicObjects</strong>) objektù tøídy <strong>CScene</strong>.</li>
  <li>Jestlie je k objektu pøiøazené svìtlo typu <strong>LT_LAMP</strong>, nahraje 
    se a pøidá se do seznamu svìtel <strong>Lights </strong>tøídy <strong>CScene</strong>, 
    navíc se indikuje pøíslušnému políèku mapy, e na nìm stojí lampa. Jestlie 
    je svìtlo typu <strong>LT_FOGLAMP</strong>, jedná se typicky o light glow 
    billboard (prùhlednou texturu nahrazující svit svìtla). V takovém pøípadì 
    se pøíslušné svìtlo s nahranou texturou pøidá do seznamu <strong>TransparentObjects</strong> 
    tøídy <strong>CScene</strong>. Také se indikuje danému objektu, ke kterému 
    svìtlo patøí, e toto svìtlo vlastní.</li>
  <li>Nahrají se textury silnic, správnì se natoèí a pøiøadí se patøiènému políèku 
    na mapì.</li>
</ol>
<p>Auto se nahrává pomocí funkce <strong>LoadCar() </strong>implementované v souboru 
  <strong>MapInit.cpp</strong>. Jednotlivá auta se vdy nahrávají a po nahrání 
  mapy. Postup nahrávání auta je následující:</p>
<ol>
  <li><strong>Resource manager </strong>nahraje obsah souboru auta i s dalšími 
    závislımi soubory.</li>
  <li>Nahraje se grafická reprezentace auta - funkce <strong>Init() </strong>tøídy 
    <strong>CGrObjectCar</strong>.</li>
  <li>Nahraje se svìtlo od auta typu <strong>LT_CARREFLECTOR</strong> (paklie 
    ho auto má). Pøidá se k modelu auta.</li>
  <li>Nahrají se svìtla typu <strong>LT_FOGLAMP. </strong>Pøidají se do seznamu 
    <strong>TransparentObjects</strong> tøídy <strong>CScene</strong>. Indikuje 
    se, e patøí k danému autu.</li>
  <li>Nastaví se startovní pozice auta podle poøadí nahrávaného auta - funkce 
    <strong>SetCarPosition()</strong> implementovaná v <strong>MapInit.cpp</strong>.</li>
  <li>Nahraje se grafická reprezentace kol od auta. Pøidají se do seznamu <strong>DynamicObjects</strong> 
    tøídy <strong>CScene</strong>. Indikuje se, e kola patøí k danému autu.</li>
</ol>
<h3><a name="sec5.1.5">5.1.5 Komunikace mezi serverem a klientem</a></h3>
<p>Komunikace mezi serverem a klientem se dìje pomocí tøídy <strong>CNetClient</strong>. 
  Komunikace se dìje dvojím zpùsobem: </p>
<ol>
  <li><strong>Broadcast</strong> - je posílán všesmìrovì po lokální síti nespojovanì, 
    nespolehlivì pomocí UDP datagramù</li>
  <li><strong>Pøímá komunikace </strong>- je provádìna spojovanì a spolehlivì 
    pøes protokol TCP/IP</li>
</ol>
<p>Tøída<strong> CNetMsg</strong> implementuje síovou komunikaci pomocí <strong>Windows 
  Sockets 2</strong>. <strong>Broadcast </strong> se pouívá na to, aby se na 
  lokální síti našly herní servery naší aplikace. Komunikace pomocí broadcastu 
  probíhá implicitnì na portu 58788. Èíslo portu se dá zmìnit nastavením parametru 
  <strong>NtBroadport</strong> v <strong>options.cfg</strong>. Posílání <strong>broadcastu 
  </strong>je implementováno ve tøídì <strong>CNetMsg</strong> tøemi funkcemi 
  <strong>StartBroadcast()</strong>, <strong>StopBroadcast()</strong>, <strong>SendBroadcastMsg()</strong>. 
  <strong>Pøímá komunikace </strong>se pouívá na veškerou komunikaci s konkrétním 
  herním serverem. Na to slouí funkce <strong>SendMsg()</strong>. Jestlie nastane 
  chyba v komunikaci se serverem nebo je jinım zpùsobem komunikace pøerušena, 
  je vyhlášena chyba a komunikace se serverem skonèena. <strong>Pøímá komunikace 
  </strong>implicitnì probíhá na portu 58787. Èíslo portu se dá zmìnit nastavením 
  parametru <strong>NtPort </strong>v <strong>options.cfg</strong>.</p>
<p>Zprávy, které chodí mezi serverem a klientem pøedstavuje tøída <strong>CNetMsg</strong>.<strong> 
  </strong>Zprávy, které chodí mezi serverem a klientem jsou rùznıch typù. Typy 
  zpráv jsou následující:</p>
<ul>
  <li><strong>NETMSG_PING</strong> - Zpráva obsahující ping pro testování, jestli 
    je spojení mezi serverem a klientem ivé</li>
  <li><strong>NETMSG_PING_BACK - </strong>Odpovìï na zprávu typu <strong>NETMSG_PING. 
    </strong>Tato zpráva je urèena pro testování, jestli je spojení mezi serverem 
    a klientem ivé</li>
  <li><strong>NETMSG_ACCEPTED </strong>- Zpráva øíkající, e spojení se serverem 
    bylo úspìšnì navázáno</li>
  <li><strong>NETMSG_PLAYER_MAP_NAME</strong> - Zpráva obsahující jméno mapy (vèetnì 
    relativní cesty defaultnì z adresáøe <strong>Maps</strong>)</li>
  <li><strong>NETMSG_PLAYER_ID</strong> - Zpráva obsahující ID, jedineènou identifikaci 
    klienta, kterou klientovi pøidìluje server pøi pøipojení</li>
  <li><strong>NETMSG_PLAYER_CRC</strong> - Zpráva obsahující seznam CRC (Cyclic 
    redundancy check) souètù, které slouí ke kontrole, jestli jsou na všech stranách 
    (klientù a serveru) stejné soubory</li>
  <li><strong>NETMSG_PLAYER_CAR_NAMES</strong> - Zpráva obsahující seznam všech 
    jmen souborù aut (vèetnì relativní cesty defaultnì z adresáøe <strong>Objects</strong>)</li>
  <li><strong>NETMSG_PLAYER_STATUS</strong> - Zpráva obsahující stav hráèe - ID, 
    jméno hráèe, jméno souboru auta hráèe, je-li hráè pøipraven, je-li hráè aktivní</li>
  <li><strong>NETMSG_MAP_SETTINGS </strong>- Zpráva obsahující údaje o nastavení 
    mapy - doby hry, je-li zapnutı reim hry na kola, poèet kol</li>
  <li><strong>NETMSG_GAME_NAME </strong>- Zpráva obsahující jméno hry</li>
  <li><strong>NETMSG_CHAT</strong> - Zpráva obsahující zprávu z chatu mezi hráèi</li>
  <li><strong>NETMSG_MULTIGAME_STARTLOAD </strong>- Zpráva indikující zaèátek 
    nahrávání hry pøi multiplayeru</li>
  <li><strong>NETMSG_PLAYER_LOADED</strong> - Zpráva oznamující, e hráè (klient) 
    byl úspìšnì nahrán</li>
  <li><strong>NETMSG_STATIC_POSITION</strong> - Zpráva obsahující postavení všech 
    statickıch objektù</li>
  <li><strong>NETMSG_CAR_SPEED</strong> - Zpráva obsahující rychlost hráèova auta</li>
  <li><strong>NETMSG_CAR_GEAR</strong> - Zpráva obsahující zaøazenı stupeò rychlosti 
    auta </li>
  <li><strong>NETMSG_CHECKPOINT_POSITION </strong>- Zpráva obsahující pozici kontrolního 
    bodu na trati, kterım hráè musí projet</li>
  <li><strong>NETMSG_LAPS_GONE</strong> - Zpráva obsahující poèet odjetıch kol</li>
  <li><strong>NETMSG_RACE_POSITION</strong> - Zpráva obsahující prùbìnou hráèovu 
    pozici v závodì</li>
  <li><strong>NETMSG_RETURNTOLOBBY </strong>- Zpráva indikující poadavek o návrat 
    do lobby (tj. ukonèením multiplayeru návratem do lobby)</li>
  <li><strong>NETMSG_CAR_POSITION</strong> - Zpráva obsahující pozici auta</li>
  <li><strong>NETMSG_OBJECT_POSITION</strong> - Zpráva obsahující pozici dynamického 
    objektu</li>
  <li><strong>NETMSG_CONTROLS</strong> - Zpráva obsahující informaci o stavu kláves</li>
  <li><strong>NETMSG_BROADCAST_DEMAND</strong> - Zpráva slouící jako ádost o 
    vysílání broadcastu</li>
  <li><strong>NETMSG_BROADCAST_SERVER_INFO</strong> - Zpráva obsahující identifikaci 
    serveru v lokální síti</li>
</ul>
<p>Samotná zpráva tøídy <strong>CNetMsg</strong> je potom sestavena z délky zprávy, 
  typu zprávy a obsahu zprávy pomocí funkce <strong>SetNetMsg()</strong>.</p>
<h4><a name="sec5.1.5.1">5.1.5.1 Postup pøi nahrávání single playeru</a></h4>
<p>Nahrávání single playeru probíhá ve stavu klienta <strong>CS_SG_START</strong>. 
  Nahrávání single playeru se spouští zavoláním funkce <strong>startSinglePlayer()</strong> 
  implementované v <strong>InitFunctions.cpp</strong>. </p>
<p>Postup nahrávání single playeru je následující:</p>
<ol>
  <li>Nahraje se server - funkce <strong>StartServerSingle()</strong> tøídy <strong>CServer</strong>.</li>
  <li>Nahraje se klient - funkce <strong>ClientStartSingleLoad()</strong>. </li>
  <li>Klient naváe se serverem spojení.</li>
  <li>Server se pøepne do stavu <strong>SS_GAME_PLAY</strong>.</li>
  <li>Server klientovi pošle pozice všech statickıch objektù na mapì - funkce 
    <strong>SendAllStaticObjectsPositions(), </strong>zpráva <strong>NETMSG_STATIC_POSITION</strong>.</li>
  <li>Server klientovi pošle pozice všech dynamickıch objektù na mapì - funkce 
    <strong>SendAllDynamicObjectsPositions()</strong>, zpráva <strong>NETMSG_OBJECT_POSITION</strong>.</li>
  <li>Pokud se jedná o mód hry na kola, pošle server klientovi pozici prvního 
    checkpointu. Zpráva <strong>NETMSG_CHECKPOINT_POSITION</strong>.</li>
  <li>Server klientovi pošle zprávu <strong>NETMSG_ACCEPTED</strong>.</li>
  <li>Klient pøijme všechny zprávy.</li>
  <li>Klient se pøepne do stavu <strong>CS_GAME_PLAY</strong>.</li>
</ol>
<h4><a name="sec5.1.5.2">5.1.5.2 Postup pøi lokalizaci herních serverù</a></h4>
<p>Klient pøijímá info o herním serveru pouze ve stavu <strong>CS_MG_ENUMERATE_HOSTS</strong>. 
</p>
<p>Celı postup je následující:</p>
<ol>
  <li>Pøepnutím klienta do stavu <strong>CS_MG_ENUMERATE_HOSTS</strong> se nastartuje 
    sluba broadcastu voláním funkce <strong>StartBroadcast()</strong>.</li>
  <li>Periodicky se posílá zpráva typu <strong>NETMSG_BROADCAST_DEMAND</strong> 
    pomocí funkce <strong>SendServersInfoDemand()</strong>.</li>
  <li>Jestlie se v lokální síti nachází nìjakı herní server naší hry, odpoví 
    zprávou typu <strong>NETMSG_BROADCAST_SERVER_INFO</strong>.</li>
  <li>Zpráva typu <strong>NETMSG_BROADCAST_SERVER_INFO </strong>je pøijata message 
    handler funkcí <strong>ClientMultiEnumMH()</strong>.</li>
  <li>Herní server je pøidán do seznamu herních serverù pomocí funkce <strong>AddServer()</strong>.</li>
  <li>Pokud je server urèitou dobu neaktivní, je ze seznamu herních serverù zase 
    vyøazen.</li>
</ol>
<h4><a name="sec5.1.5.3">5.1.5.3 Postup pøi pøipojování klienta na server</a></h4>
<p>Jestlie se klient úspìšnì pøipojí k serveru, skonèí klient ve stavu <strong>CS_MG_START</strong> 
  a informaèní stav tøídy <strong>CMultiPlayerGameInfo </strong>skonèí ve stavu 
  <strong>PHASE_THREE</strong>.</p>
<p>Postup pøipojení klienta k serveru je následující:</p>
<ol>
  <li>Klient se pøipojí k serveru - funkce <strong>ConnectToServer() </strong>tøídy 
    <strong>CClient</strong>. </li>
  <li>Server pøijme hráèe. Jestlie server odmítne hráèe, komunikace skonèila 
    a server hráèe odpojí.</li>
  <li>Server pošle klientovi zprávu, e byl pøijat - zpráva <strong>NETMSG_ACCEPTED</strong>.</li>
  <li>Server pošle klientovi jeho unikátní ID - zpráva <strong>NETMSG_PLAYER_ID</strong>.</li>
  <li>Server pošle klientovi jméno hry - zpráva <strong>NETMSG_GAME_NAME</strong>.</li>
  <li>Server pošle klientovi jméno mapy a pøíslušné kontrolní souèty pøiøazené 
    k mapì. Zprávy <strong>NETMSG_PLAYER_MAP_NAME </strong>a <strong>NETMSG_PLAYER_CRC</strong>.</li>
  <li>Server rozešle všem ostatním klientùm zprávu o tom, e byl pøijat novı klient.</li>
  <li>Klient pøijme zprávu <strong>NETMSG_ACCEPTED</strong> a nastaví stav informaèní 
    tøídy <strong>CMultiPlayerGameInfo</strong> na <strong>PHASE_ONE</strong>.</li>
  <li>Klient pøijme zprávu <strong>NETMSG_PLAYER_ID </strong>a zapamatuje si svoje 
    ID - funkce <strong>SetID()</strong> tøídy <strong>CMultiPlayerGameInfo</strong>.</li>
  <li>Klient pøijme zprávu <strong>NETMSG_GAME_NAME </strong>a zapamatuje si jméno 
    hry - funkce <strong>SetGameName()</strong> tøídy <strong>CMultiPlayerGameInfo</strong>.</li>
  <li>Klient pøijme zprávu <strong>NETMSG_PLAYER_MAP_NAME, </strong>zapamatuje 
    si jméno mapy a spoèítá kontrolní souèty k mapì - funkce <strong>SetMapFileName()</strong> 
    tøídy <strong>CMultiPlayerGameInfo</strong>. Jestlie mapa na klientovi neexistuje, 
    klient se odpojí a vyhlásí se chyba pøipojování k serveru.</li>
  <li>Klient pøijme zprávu <strong>NETMSG_PLAYER_CRC </strong>a porovná pøíchozí 
    kontrolní souèty k mapì s vlastoruènì spoèítanımi kontrolními souèty mapy. 
    Jestlie se kontrolní souèty liší, klient se odpojí a vyhlásí se chyba pøipojování 
    k serveru. Klient se pøepne do stavu <strong>PHASE_TWO</strong> tøídy <strong>CMultiPlayerGameInfo.</strong></li>
  <li>Klient pošle serveru seznam všech aut, které má a postupnì jejich kontrolní 
    souèty. Zprávy <strong>NETMSG_PLAYER_CAR_NAMES</strong> a <strong>NETMSG_PLAYER_CRC</strong>.</li>
  <li>Server pøijme seznam jmen aut a jejich kontrolní souèty.</li>
  <li>Server spoèítá mnoinu aut, která je spoleèná všem klientùm - funkce <strong>CompareCarsFileNames()</strong>.</li>
  <li>Funkce rozešle tuto spoleènou mnoinu povolenıch aut všem klientùm. Zprávy 
    <strong>NETMSG_PLAYER_CAR_NAMES</strong>.</li>
  <li>Klient pøijme mnoinu všech povolenıch aut a zapamatuje si ji - funkce <strong>SetAllowedCarsFileNames()</strong> 
    tøídy <strong>CMultiPlayerGameInfo</strong>.</li>
  <li>Klient se pøepne informaèní stav tøídy <strong>CMultiPlayerGameInfo</strong> 
    do stavu <strong>PHASE_THREE</strong>.</li>
</ol>
<h4><a name="sec5.1.5.4">5.1.5.4 Komunikace klienta se serverem ve stavu pøipojení k serveru</a></h4>
<p>Komunikace klienta se serverem ve stavu pøipojení k serveru probíhá ve stavu 
  klienta <strong>CS_MG_START</strong>. </p>
<p>Server zasílá klientovi podle potøeby následující informace:</p>
<ul>
  <li>Zprávu <strong>NETMSG_PLAYER_CAR_NAMES </strong>- obsahuje mnoinu pouitelnıch 
    aut pro závod</li>
  <li>Zprávu <strong>NETMSG_MAP_SETTINGS </strong>- Nastavení mapy - poèet kol, 
    mód závodìní na kola, denní dobu</li>
  <li>Zprávu <strong>NETMSG_PLAYER_STATUS - </strong>Nastavení nìkterého z ostatních 
    klientù nebo hráèe AI</li>
  <li>Zprávu <strong>NETMSG_CHAT - </strong>Zpráva z chatu.</li>
</ul>
<p>Klient serveru zasílá následující informace podle potøeby:</p>
<ul>
  <li>Zprávu <strong>NETMSG_PLAYER_STATUS</strong> - nové nastavení hráèe klienta 
  </li>
</ul>
<p>&nbsp;</p>
<h4><a name="sec5.1.5.5">5.1.5.5 Postup nahrávání klienta pøi nahrávání hry multiplayeru</a></h4>
<p>Nahrávání klienta mùe zaèít pouze tehdy, je-li klient ve stavu <strong>CS_MG_START</strong> 
  a informaèní stav tøídy <strong>CMultiPlayerGameInfo</strong> je ve stavu <strong>PHASE_THREE</strong>. 
  V prùbìhu nahrávání je klient ve stavu <strong>CS_MG_START_LOAD</strong> a stavu 
  <strong>PHASE_FOUR </strong>informaèní tøídy <strong>CMultiPlayerGameInfo</strong>. 
  Jestlie nahrávání probìhne úspìšnì, je stav informaèní tøídy <strong>CMultiPlayerGameInfo 
  </strong>nastaven na <strong>PHASE_FIVE</strong> a stav klienta je <strong>CS_GAME_PLAY</strong>.</p>
<p>Postup nahrávání klienta pøi multiplayeru je následující:</p>
<ol>
  <li>Klient obdrí od serveru zprávu <strong>NETMSG_MULTIGAME_STARTLOAD</strong>, 
    která indikuje zaèátek nahrávání.</li>
  <li>Klient pøepne informaèní stav do stavu <strong>PHASE_FOUR</strong>, èím 
    indikuje zaèátek nahrávání.</li>
  <li>Zavolá se funkce <strong>ClientStartMultiLoad()</strong> tøídy <strong>CClient</strong>. 
    Zmìní se stav klienta na <strong>CS_MG_START_LOAD</strong>.</li>
  <li>Klient nahraje se mapu a auta.</li>
  <li>Klient pošle zprávu serveru <strong>NETMSG_PLAYER_LOADED</strong>.</li>
  <li>Server si poèká, ne jsou všichni klienti nahráni - funkce <strong>CheckAllPlayersLoaded()</strong> 
    tøídy <strong>CServer</strong>.</li>
  <li>Server klientovi pošle pozice všech statickıch objektù na mapì - funkce 
    <strong>SendAllStaticObjectsPositions(), </strong>zpráva <strong>NETMSG_STATIC_POSITION</strong>.</li>
  <li>Server klientovi pošle pozice všech dynamickıch objektù na mapì - funkce 
    <strong>SendAllDynamicObjectsPositions()</strong>, zpráva <strong>NETMSG_OBJECT_POSITION</strong>.</li>
  <li>Pokud se jedná o mód "hra na kola", pošle server klientovi pozici prvního 
    checkpointu. Zpráva <strong>NETMSG_CHECKPOINT_POSITION</strong>.</li>
  <li>Server pošle klientovi zprávu <strong>NETMSG_PLAYER_LOADED</strong>, èím 
    indikuje, e všichni klienti jsou nahráni.</li>
  <li>Server se pøepne do stavu <strong>SS_GAME_PLAY</strong> a stav informaèní 
    tøídy <strong>CMultiPlayerGameInfo </strong>nastaví na <strong>PHASE_FIVE</strong>.</li>
  <li>Klient pøijme všechny zprávy.</li>
  <li>Klient se pøepne do stavu <strong>CS_GAME_PLAY</strong> a stav informaèní 
    tøídy <strong>CMultiPlayerGameInfo </strong>nastaví na <strong>PHASE_FIVE</strong>.</li>
</ol>
<h4><a name="sec5.1.5.6">5.1.5.6 Komunikace mezi serverem a klientem pøi samotné høe</a></h4>
<p>Komunikace mezi serverem a klientem pøi samotné høe probíhá pøi stavu klienta <strong>CS_GAME_PLAY</strong> a stavu serveru <strong>SS_GAME_PLAY</strong>. 
  Klient posílá serveru info o stavu stisknutıch kláves - zpráva <strong>NETMSG_CONTROLS</strong>. 
  Server posílá klientovi zmìnìné pozice aut a dynamickıch objektù - zprávy <strong>NETMSG_CAR_POSITION</strong> 
  a <strong>NETMSG_OBJECT_POSITION</strong>. Navíc server posílá klientovi podle 
  potøeby následující zprávy:</p>
<ul>
  <li><strong>NETMSG_CAR_GEAR - </strong>zpráva o tom, e se zmìnil rychlostní 
    stupeò auta</li>
  <li><strong>NETMSG_CAR_SPEED</strong> - zpráva o tom, e se zmìnila rychlost 
    auta</li>
  <li><strong>NETMSG_CHECKPOINT_POSITION </strong>- nová pozice checkpointu</li>
  <li><strong>NETMSG_LAPS_GONE</strong> - zpráva o tom, e klient odjel kolo</li>
  <li><strong>NETMSG_RACE_POSITION </strong>- prùbìná pozice jednotlivıch aut 
    v závodì</li>
  <li><strong>NETMSG_RETURNTOLOBBY </strong>- ádost o návrat do lobby</li>
</ul>
<h4><a name="sec5.1.5.7">5.1.5.7 Komunikace mezi serverem a klientem ve stavu vısledkù závodu (race results)</a></h4>
<p>Do stavu <strong>CS_RACE_RESULT </strong>se klient pøepíná v pøípadì, e je 
  aktivován mód "závodìní na kola" a klient dokonèil závod. V tomto stavu mùe klient 
  vyslat ádost k serveru o návrat do lobby, jedná-li se o hru multiplayeru - 
  zpráva <strong>NETMSG_RETURNTOLOBBY</strong>. A potom èekat na potvrzení serveru 
  o tom, e se navrátil do lobby - zpráva <strong>NETMSG_RETURNTOLOBBY</strong>.</p>
<h3><a name="sec5.1.6">5.1.6 Pomocná informaèní tøída CMultiPlayerGameInfo</a></h3>
<p>Pomocná informaèní tøída <strong>CMultiPlayerGameInfo </strong>slouí zejména 
  k zapamatování momentálního nastavení single playeru a multiplayeru. Tøídu 
  <strong>CMultiPlayerGameInfo </strong> pouívá jak server, tak klient. Tøída 
  <strong>CMultiPlayerGameInfo</strong> obsahuje tedy funkce a informace, které 
  pouívá server a klient spoleènì, a navíc data, které vyuívá buï jenom 
  server nebo jenom klient. Jedná se hlavnì o nastavení jednotlivıch klientù - 
  jmen hráèù, aut hráèù, stavu klienta, stavu pøipravenosti k nahrávání. Tøída si také ukládá jména hry a mapy a vıpoèet kontrolních souètù za 
  pomoci <strong>Resource manageru</strong> a obsahuje funkce a informace pro vıpoèet spoleèné mnoiny 
  aut všech klientù a serveru, které je moné pøi spoleèné høe pouít. Ve tøídì 
  <strong>CMultiPlayerGameInfo </strong>jsou uloené informace o prùbìhu závodu, o stavu nahrávání hry serveru a klienta a 
  funkce, které umí &quot;rozbalit&quot; a &quot;zabalit&quot; 
  informace do zprávy tøídy <strong>CNetMsg</strong>. </p>
<p>Tøída <strong>CMultiPlayerGameInfo </strong>obsahuje informaèní stav, kterı 
  slouí jako jemnìjší rozdìlení stavu pro pøipojování klienta k serveru a pro 
  nahrávání serveru a klienta. Informaèní stav se dá získat pomocí funkce <strong>GetState()</strong>. 
  Informaèní stav se dá nastavit pomocí funkce <strong>SetState()</strong>.</p>
<p>Jsou moné následující informaèní stavy:</p>
<ol>
  <li><strong>PHASE_ZERO - </strong>Pro klienta znamená, e klient není pøipojen 
    k serveru a ani se o to nepokouší. Pro server znamená, e není spuštìn.</li>
  <li><strong>PHASE_ONE </strong>- Pro klienta znamená, e se pokouší o pøipojení 
    k serveru. Tento stav zaèíná u klienta pokusem pøipojení k serveru a konèí 
    úplnou verifikací mapy - stejné jméno mapy, stejné kontrolní souèty k mapì. 
    Pro server tento stav nemá vıznam.</li>
  <li><strong>PHASE_TWO </strong>- Pro klienta znamená, e se zaèíná verifikace 
    monıch aut. Tento stav konèí tím, e ze serveru pøijde klientovi mnoiny 
    monıch aut pro závod. Pro server tento stav nemá vıznam.</li>
  <li><strong>PHASE_THREE </strong>- Pro klienta znamená, e je pøipojen k serveru. 
    Pro server znamená, e je spuštìnı.</li>
  <li><strong>PHASE_FOUR </strong>- Pro klienta i pro server znamená zaèátek nahrávání 
    samotné hry.</li>
  <li><strong>PHASE_FIVE </strong>- Pro klienta i pro server znamená, e hra byla 
    úspìšnì nahraná.</li>
</ol>
<h3><a name="sec5.1.7">5.1.7 Tøída CGameInfo</a></h3>
<p>Tøída <strong>CGameInfo </strong>zajišuje funkce prohledávání adresáøù, aby 
  tak vytvoøila seznam map, aut a hudby. Stará se o ukládání, nahrávání a 
  o pøistup do traovıch rekordù. </p>
<p>Vyhledávání souborù s mapou, autem a hudbou se dìje pøi inicializaci tøídy 
  <strong>CGameInfo </strong>funkcí <strong>Init()</strong>. Prohledávají se adresáøe 
  nastavené v konfiguraci pro danı typ souboru s tím, e se prohledá i kompletní 
  podadresáøová struktura takovıch adresáøù. Oèekává se, e taková podadresáøová 
  struktura nebude pøíliš rozsáhlá. Vısledky hledání se potom ukládají do seznamù 
  <strong>CarNames</strong>, <strong>MapNames</strong> a <strong>MusicNames</strong>, 
  odkud jsou pøístupné pro ostatní èásti programu, které je potøebují.</p>
<p>Traové rekordy jsou uloeny v souboru <strong>BestResults.dat</strong>. Tøída 
  <strong>CGameInfo </strong>je nahrává pomocí funkce <strong>LoadBestResults()</strong> 
  a ukládá pomocí funkce <strong>SaveBestResults()</strong>. Pøístupné jsou pak 
  skrze seznam <strong>BestResults</strong> pro ostatní èásti programu, které 
  je potøebují. Formát souboru <strong>BestResults.dat </strong> je popsanı v 
  dokumentaci formátù souborù pouívanıch v naší aplikaci.</p>
  
  <h2><a name="sec5.2">5.2 Server</a></h2>
<h3><a name="sec5.2.1">5.2.1 Úvod</a></h3>
<p>Server zajišuje komunikaci s jednotlivımi klienty. Pro kadou, a u síovou 
  (multiplayer) nebo lokální (singleplayer) hru, tu musí bıt server. Server volá 
  vıpoèet fyziky a vısledky zprostøedkovává jednotlivım klientùm. 
  Server také volá systém AI, kterı má za úkol poèítaèové øízení aut. Server je nadøazen fyzikálnímu enginu a systému AI (systém umìlé inteligence). 
  Vyuívá slueb Resource manageru, konfigurace a dalších èástí 
  poskytujících globální sluby (projekt <strong>Globals</strong>). Informací 
  ze serveru pak pouívají zejména Dialogy. Server mùe bìet buï na poèítaèi, 
  kde bìí i klient nebo jako dedikovanı na samostatném poèítaèi.</p>
<p class="center"><img src="images/ServerPosition.png" width="399" height="420"></p>
<p class="center"><strong>Obrázek 5.3: Postavení serveru vùèi ostatním èástem aplikace</strong></p>
<h3><a name="sec5.2.2">5.2.2 Implementace serveru</a></h3>
<p>Implementace serveru se skládá z následujících èástí:</p>
<ol>
  <li>Tøída <strong>CServer </strong> - je jádrem implementace serveru. Uchovává 
    stav serveru, ve kterém se server nachází. Pro kadı stav obsahuje funkci, 
    která slouí jako message handler (zpracovatel zpráv) pøicházejících od klientù. 
    Zajišuje volání poèítání fyziky, AI a sama poèítá waypointy (body, kterımi 
    musí hráè na trati projet) a prùbìnou pozici hráèù v závodì. Obsahuje síové 
    sluby v podobì tøíd <strong>CNetServer </strong>a <strong>CNetMsg</strong>. 
    Takté obsahuje informaèní tøídu <strong>CMultiPlayerGameInfo</strong>.</li>
  <li>Síové sluby v podobì tøíd <strong>CNetServer </strong> a <strong>CNetClient</strong>. 
    Tøída <strong>CNetMsg </strong>implementuje zprávy, které chodí po síti. Tøída 
    <strong>CNetServer </strong>zajišuje pøíjem a posílání zpráv jednotlivım 
    klientùm a rozesílá a pøíjem broadcastu. Typy zpráv a tøída <strong>CNetMsg</strong> 
    je popsána v dokumentaci klienta.</li>
  <li>Informaèní tøídu <strong>CMultiPlayerGameInfo</strong>. Slouí zejména jako 
    tøída pro uchovávání informací, jak pro server, tak pro klienta. Popis této 
    tøídy se nachází v dokumentaci ke klientovi a nebude v dokumentaci serveru 
    popisována.</li>
  <li>Soubory <strong>MapInit.h </strong> a <strong>MapInit.cpp</strong>, ve kterıch 
    jsou umístìny funkce pro nahrávání mapy a aut na serveru.</li>
</ol>
<p class="center"><img src="images/ServerClass.png" width="391" height="379"></p>
<p class="center"><strong>Obrázek 5.4: Jednotlivé souèásti serveru</strong></p>
<h3><a name="sec5.2.3">5.2.3 Jádro serveru - tøída CServer</a></h3>
<p>Server se mùe nacházet v rùznıch stavech. Podle stavu, ve kterém se 
  nachází, se volá pøíslušná funkce slouící jako message handler (zpracovatel 
  zpráv) pøíchozích od klientù. Stav serveru se dá zmìnit voláním funkce <strong>ChangeServerState()</strong>. 
  Stavy, ve kterıch se server mùe nacházet jsou následující:</p>
<ul>
  <li><strong>SS_NULL - </strong>Server není spuštìn.</li>
  <li><strong>SS_SG_START - </strong>Probíhá nahrávání hry na stranì serveru pro 
    singleplayer (hru jednoho hráèe).</li>
  <li><strong>SS_MG_START - </strong>Server je spuštìn pro multiplayer (hru více 
    hráèù). Klienti se mohou pøipojovat k serveru.</li>
  <li><strong>SS_MG_START_LOAD </strong>- Probíhá nahrávání hry na stranì serveru 
    pro multiplayer.</li>
  <li><strong>SS_GAME_PLAY </strong>- Probíhá samotná hra. Na serveru se periodicky 
    poèítá fyzika, AI a jiné herní záleitosti.</li>
</ul>
<p>Funkce <strong>ServerGameMH()</strong> podle stavu, ve kterém se server nachází, 
  zavolá pøíslušnou funkci message handleru, která se postará o vıbìr a zpracování 
  zpráv od klientù. Jedná se o následující funkce:</p>
<ul>
  <li><strong>ServerSingleStartMH()</strong> pro stav <strong>SS_SG_START</strong></li>
  <li><strong>ServerMultiStartMH()</strong> pro stav <strong>SS_MG_START</strong></li>
  <li><strong>ServerMultiStartLoadMH </strong>pro stav <strong>SS_MG_START_LOAD</strong></li>
  <li><strong>ServerGameMH() </strong>pro stav <strong>SS_GAME_PLAY</strong></li>
</ul>
<p>Funkce <strong>ServerGameMH()</strong> se volá periodicky, aby byl zajištìn 
  vıbìr zpráv do klientù. </p>
<p>Nejdùleitìjší funkcí tøídy <strong>CServer </strong>je funkce <strong>updateGame(), 
  </strong>která ve stavu hry <strong>SS_GAME_PLAY </strong>zajišuje aktualizování 
  fyziky, AI, prùbìného poøadí v závodì atd. Ve funkci <strong>updateGame()</strong> 
  se provedou následující úkony:</p>
<ol>
  <li>Zavolá se aktualizace fyziky - funkce <strong>Update() </strong>tøídy <strong>CPhysics</strong>.</li>
  <li>Zavolá se aktualizace AI - funkce <strong>Update() </strong>tøídy <strong>CSteeringAI</strong>.</li>
  <li>Zavolá se aktualizace stavu hry, která provede: 
    <ol>
      <li>Pošle všem klientùm informaci o zaøazené rychlosti a rychlosti auta 
        - zprávy <strong>NETMSG_CAR_SPEED</strong> a <strong>NETMSG_CAR_GEAR</strong>.</li>
      <li>Kontrolu, jestli nìkterı klient neprojel checkpointem (kontrolním bodem 
        na trati, kterım klient musí projet v pøípadì, e se závodí v reimu závodu 
        na kola). Jestlie nìkterı klient vjel do oblasti checkpointu, pošle se 
        mu pozice nového checkpointu - zpráva <strong>NETMSG_CHECKPOINT_POSITION</strong>.</li>
      <li>Kontrolu, jestli nìkterı klient nedokonèil kolo. V takovém pøípadì se 
        klientovi pošle zpráva <strong>NETMSG_LAPS_GONE</strong>.</li>
      <li>Vıpoèet prùbìného poøadí na trati - funkce <strong>UpdateRacePositions()</strong>. 
        Jestlie se prùbìné poøadí zmìnilo, pošle se všem klientùm ve zprávách 
        <strong>NETMSG_RACE_POSITION</strong>.</li>
    </ol>
  </li>
  <li>Pro kadou zmìnìnou polohu auta se pošle všem klientùm zpráva <strong>NETMSG_CAR_POSITION</strong>.</li>
  <li>Pro kadou zmìnìnou polohu dynamického objektu se pošle všem klientùm zpráva 
    <strong>NETMSG_OBJECT_POSITION</strong>.</li>
</ol>
<p>Popis typù zpráv a toho, co znamenají se nachází v dokumentaci klienta. Stejnì 
  tak je v dokumentaci klienta popis tøídy <strong>CNetMsg</strong>, proto zde 
  nebude popisována.</p>
<p>Pozice checkpointù se poèítají pomocí funkce <strong>ComputeCheckpointPositions()</strong> 
  z waypointù (bodù, které pouívá AI na øízení aut øízenıch poèítaèem). Pozice 
  checkpointù jsou umístìny pøiblinì 20 metrù od sebe a na objektech, které mají 
  checkpoint povinnı.</p>
<h3><a name="sec5.2.4">5.2.4 Popis nahrávání mapy a auta na stranì serveru</a></h3>
<p>Mapa na stranì serveru se nahrává pomocí funkce <strong>MapPhInit() </strong>implementované 
  v souboru <strong>MapInit.cpp</strong>. Postup nahrávání mapy je následující:</p>
<ol>
  <li><strong>Resource manager </strong>nahraje obsah souboru mapy i s dalšími 
    závislımi soubory na mapì.</li>
  <li>Fyzika nahraje terén - funkce <strong>LoadMap() </strong>tøídy <strong>CPhysics</strong>.</li>
  <li>Nahrají se jednotlivé objekty na mapì z hlediska fyziky a pøidají se do seznamu 
    statickıch nebo dynamickıch objektù fyziky <strong>staticObjects </strong>èi 
    <strong>dynamicObjects</strong>.</li>
  <li>Pro silnice se nahraje fyzikální textura povrchu.</li>
</ol>
<p>Auto na stranì serveru se nahrává pomocí funkce <strong>LoadPhCar()</strong> 
  implementované v souboru <strong>MapInit.cpp</strong>. Postup nahrávání auta 
  je následující:</p>
<ol>
  <li><strong>Resource manager </strong>nahraje obsah souboru auta i s dalšími 
    závislımi soubory na mapì.</li>
  <li>Nahraje se auto v podobì tøídy <strong>CCar </strong>a pøidá se do seznamu 
    aut fyziky <strong>cars</strong> tøídy <strong>CPhysics</strong>.</li>
</ol>
<h3><a name="sec5.2.5">5.2.5 Tøída CNetServer</a></h3>
<p>Tøída <strong>CNetServer</strong> slouí jako prostøedek síové komunikace 
  mezi klientem a serverem na stranì serveru. Tøída <strong>CNetServer </strong>umí 
  rozesílat všesmìrové <strong>broadcast </strong>po lokální síti<strong> </strong>pomocí 
  funkcí <strong>StartBroadCast()</strong>, <strong>StopBroadcast()</strong>, 
  <strong>BindBroadcast()</strong>, <strong>SendBroadcastMsg()</strong>. <strong>Broadcast 
  </strong>slouí k posílání informací o bìícím herním serveru naší hry. Standardnì 
   tøída <strong>CNetServer</strong> komunikuje s klienty pomocí protokolu 
  TCP/IP spolehlivì a spojovanì. Serverová strana síové komunikace se spouští 
  pomocí funkce <strong>HostSession()</strong> a vypíná pomocí <strong>StopSession()</strong>. 
  Komunikace s jednotlivımi klienty se potvrzuje pomocí funkce <strong>AcceptPlayer()</strong>. 
  Funkce <strong>SendMsg()</strong> a <strong>SendMsgToSocket() </strong>slouí 
  k posílání zpráv klientùm. Funkce <strong>IsConnected()</strong> vrací stav 
  pøipojení jednotlivıch klientù. Tøída <strong>CNetServer </strong>je implementována 
  pomocí Windows Sockets 2.</p>
<h4><a name="sec5.2.5.1">5.2.5.1 Známé chyby</a></h4>
<p>Pøi posílání zprávy mùe nastat zablokování socketu. V tom pøípadì se pokusí 
  tøída <strong>CNetServer </strong>poèkat a zprávu odeslat pozdìji. To ovšem 
  mùe zablokovat hru a na jednu vteøinu. Problém nastává díky jednothreadovému 
  (jednovláknovému) øešení naší aplikace. Problém by se dal vyøešit pouštìním 
  serveru na samostatném vláknu. Z èasovıch dùvodu tento problém nebyl odstranìn. 
  Problém nastává zøídka, nejèastìji pøi náhlém a nestandardním odpojení nìkterého 
  z klientù od serveru.</p>
<p></p>
<h3><a name="sec5.2.6">5.2.6 Postup spuštìní serveru pro multiplayer</a></h3>
<p>Pøed spuštìním serveru je server ve stavu <strong>SS_NULL</strong>. Po spuštìní 
  serveru se server nachází ve stavu <strong>SS_MG_START</strong>. Spuštìní serveru 
  pro multiplayer probíhá pomocí funkce <strong>startServerMulti()</strong> implementované 
  v <strong>InitFunctions.cpp</strong>. Postup spuštìní serveru pro multiplayer 
  je následující:</p>
<ol>
  <li>Nastaví se jméno hry (identifikace serveru) - funkce <strong>SetGameName()</strong> 
    tøídy <strong>CMultiPlayerGameInfo</strong>.</li>
  <li>Nastaví se jméno mapy a spoèítají se pro ni kontrolní souèty - funkce <strong>SetMapFileName()</strong> 
    tøídy <strong>CMultiPlayerGameInfo</strong>.</li>
  <li>Spustí se naslouchání serveru - funkce <strong>HostSession()</strong> tøídy 
    <strong>CNetServer</strong>.</li>
  <li>Stav serveru se pøepne do <strong>SS_MG_START</strong>.</li>
  <li>Spustí se všesmìrovı broadcast serveru, aby mohl o sobì server podat zprávu 
    ostatním klientùm v lokální síti.</li>
  <li>Jestlie server není dedikovanı, pøipojí se k serveru lokální klient.</li>
</ol>




<h2><a name="sec5.3">5.3 GUI (Graphic user interface)</a></h2>
<p>Pøed spuštìním samotné hry závodù aut je nutné dát uivateli monost navolit 
  si rùzné její parametry, nastavit zobrazování, hudbu, klávesy, atd... Pro tyto 
  úèely bylo nutné implementovat grafické uivatelské rozhraní 
  (GUI). Protoe se v prostøedí DirectX nedají pouít dialogy a ovládací prvky 
  Windows, rozhodli jsme se implementovat vlastní systém grafického uivatelského 
  rozhraní. Náš systém grafického uivatelského rozhraní - dialogy je zaloen 
  na vlastní implementaci potøebnıch ovládacích prvkù, které jsou implementovány 
  v grafické èásti. Celá implementace dialogù se nachází v souborech <strong>dialogs.h 
  </strong>a <strong>dialogs.cpp</strong>. </p>
<h3><a name="sec5.3.1">5.3.1 Implementace dialogù</a></h3>
<p>Základem implementace dialogù je tøída <strong>CMyDialogs</strong>, která obsahuje 
  všechny ostatní tøídy pøedstavující jednotlivé dialogy. Jednotlivé dialogy jsou 
  potom odvozeny od tøídy <strong>CMyDialog</strong>, která obsahuje spoleènı 
  základní interface pro všechny dialogy. Jednotlivé dialogy pak pøedstavují následující 
  tøídy:</p>
<ul>
  <li><strong>CDedicatedServerDialog</strong> - Tøída pøedstavující dialog, kterı 
    se zobrazuje pøi spuštìní dedikovaného serveru</li>
  <li><strong>CGraphicSettings </strong>- Tøída pøedstavující dialog nastavení 
    grafiky</li>
  <li><strong>CInGameDialog</strong> - Tøída pøedstavující dialog, kterı se zobrazuje 
    pøi hraní samotné hry</li>
  <li><strong>CKeySettingsDialog </strong>- Tøída pøedstavující dialog nastavení 
    kláves</li>
  <li> <strong>CMainDialog</strong> - Tøída pøedstavující hlavní dialog, hlavní 
    nabídku, která se zobrazuje po spuštìní hry</li>
  <li><strong>CMessageBox </strong>- Tøída pøedstavující message box (dialog podávající 
    zprávu o nìèem)</li>
  <li><strong>CMultiCreateServerDialog</strong> - Tøída pøedstavující dialog vytvoøení 
    serveru</li>
  <li> <strong>CMultiPlayerDialog</strong> - Tøída pøedstavující poèáteèní dialog 
    multiplayeru nabízející monosti pøipojení a vytvoøení serveru</li>
  <li><strong>CMultiPlayerSettingsDialog </strong>- Tøída pøedstavující nastavení 
    hráèe pro multiplayer</li>
  <li><strong>CMultiPlayerWaitDialog </strong>- Tøída pøedstavující dialog èekání 
    na pøipojení k serveru</li>
  <li><strong>CMultiStartGameDialog </strong>- Tøída pøedstavující multiplayer 
    lobby - místo, kde se schází hráèi pøipojení k serveru pøed zapoènutím samotné 
    hry</li>
  <li><strong>COpponentsDialog </strong>- Tøída pøedstavující dialog urèenı k 
    vıbìru oponentù</li>
  <li><strong>CRaceResultDialog </strong>- Tøída pøedstavující dialog vısledkù 
    závodu</li>
  <li><strong>CSettingsDialog </strong>- Tøída pøedstavující dialog nastavení, 
    ze kterého se dá jít na dialogy nastavení pro grafiku, zvuk a ovládání</li>
  <li><strong>CSinglePlayerDialog </strong>- Tøída pøedstavující dialog nastavení 
    hry pro jednoho hráèe</li>
  <li><strong>CSoundSettingsDialog </strong> - Tøída pøedstavující dialog nastavení 
    zvuku</li>
  <li> <strong>CToLobbyWaitDialog </strong>- Tøída pøedstavující dialog èekání 
    na návrat do multiplayer lobby</li>
  <li><strong>CWaitDialog </strong>- Tøída pøedstavující dialog èekání pøi nahrávání 
    samotné hry </li>
</ul>
<p class="center"><img src="images/DialogsClass.png" width="310" height="437"></p>
<p class="center"><strong>Obrázek 5.5: Schéma propojení tøíd dialogù</strong></p>
<h3><a name="sec5.3.2">5.3.2 Tøída CMyDialogs</a></h3>
<p>Tøída <strong>CMyDialogs </strong> v sobì obsahuje všechny tøídy dialogù. Tøída 
  <strong>CMyDialogs </strong>umoòuje zobrazit a skrıt dialogy pomocí funkcí 
  <strong>showDialog() </strong>a <strong>hideDialog()</strong>. Vdy mùe bıt 
  zobrazen pouze jeden dialog. Je to dialog, na nìj ukazuje pointer <strong>pActDialog</strong>. 
  Tøída <strong>CMyDialogs </strong>zahajuje inicializaci jednotlivıch dialogù 
  - funkce <strong>init()</strong>.</p>
<h3><a name="sec5.3.3">5.3.3 Tøída CMyDialog</a></h3>
<p>Tøída <strong>CMyDialog </strong>obsahuje spoleènı základní interface pro jednotlivé 
  tøídy dialogù. Jedná se o inicializaci (funkce <strong>init()</strong>) a funkce, 
  které se volají pøi vstupu a odchodu z dialogu (funkce <strong>OnLeave() </strong>a 
  <strong>OnEnter()</strong>). Inicializace dialogù se dìje tak, e se nejprve 
  nahrají jednotlivé ovládací prvky ze souboru, potom se pøiøadí k jednotlivım 
  promìnnım konkrétního dialogu a nakonec se k jednotlivım prvkù nastaví funkce 
  volané na jednotlivé události (napøíklad stisknutí myši nad tlaèítkem).</p>
<p>Pro zjednodušení práce s dialogy byla zøízena následující makra:</p>
<ul>
  <li><strong>CHANGE_ACTDIALOG()</strong> - zmìní aktuální dialog na jinı</li>
  <li><strong>CREATE_AND_INIT_DIALOG()</strong> - vytvoøí dialog a zavolá jeho 
    inicializaci</li>
  <li><strong>GETDIALOGCONTROL()</strong>, <strong>GETDIALOGCONTROL2() </strong>- 
    vyzvedne si ovládací prvek a pøiøadí ho k promìnné dialogu</li>
  <li><strong>SHOWMESSAGEBOX()</strong> - zobrazí dialog <strong>CMessageBox </strong>s 
    pøíslušnou zprávou pro hráèe</li>
</ul>

<h2><a name="sec5.4">5.4 HUD (Head-up display)</a></h2>
<p>Kadá závodní hra potøebuje mít svùj tachometr (ukazatel rychlosti), prùbìnou 
  tabulku poøadí, ... K tomuto slouí HUD (Head-up display), kterı &quot;navrch&quot; 
  tyto informace ukazuje. Naše implementace HUDu se skládá ze ètyøech prvkù tachometru 
  - tøída<strong> CSpeedometer</strong>, ukazatele zaøazené rychlosti - tøída 
  <strong>CGear</strong>, tabulky prùbìného poøadí - tøída <strong>CPlaceList 
  </strong>a informaèní tabulky o momentálnì hrané hudební skladbì - tøída<strong> 
  CNowPlaying</strong>. Tyto ètyøi tøídy pak zastøešuje tøída <strong>CHUD</strong>.</p>
<p>Poadavky na HUD jsou následující:</p>
<ol>
  <li>Umìt nahrát HUD ze souboru</li>
  <li>Umonit nastavení jednotlivıch prvkù HUDu</li>
</ol>
<p class="center"><img src="images/HUD.png" width="617" height="399"></p>
<p class="center"><strong>Obrázek 5.6: Schéma HUDu a jeho propojení s grafickım jádrem</strong></p>
<h5><a name="sec5.2.2.1">Tøída CHUD</a></h5>
<p>Tøída <strong>CHUD </strong>zajišuje pomocí funkce <strong>LoadHUD() </strong>nahrání 
  jednotlivıch prvkù HUDu ze souboru typu <strong>*.HUD</strong>. Dokumentace 
  obsahu souboru typu <strong>*.HUD</strong> se nachází v dokumentaci souborového 
  systému. Funkce <strong>LoadHUD() </strong>nahraje nastavení HUDu ze souboru, 
  pomocí <strong>Resouce Manageru </strong>nahraje potøebné textury a fonty a 
  inicializuje jednotlivé prvky HUDu. Potom pomocí volání funkce <strong>Register() 
  </strong>tøídy <strong>CHUD </strong>se zaregistrují veškeré èásti HUDu do jádra 
  HUDu. Tím jsou pøipraveny prvky HUDu k pouití.</p>
<h5><a name="sec5.2.2.2">Tøída CSpeedometer</a></h5>
<p>Tøída <strong>CSpeedometer </strong>pøedstavuje tachometr (ukazatel rychlosti). 
  Tachometr je umístìn v pravém dolním rohu obrazovky. Tøída <strong>CSpeedometer 
  </strong>umoòuje nastavit maximální rychlost (funkce <strong>SetMaxSpeed()</strong>) 
  a momentální rychlost pomocí funkce <strong>SetSpeed()</strong>. Tato informace 
  o rychlosti se potom zobrazuje, jak textovì, tak vizuálnì.</p>
<h5><a name="sec5.2.2.3">Tøída CGear</a></h5>
<p>Tøída <strong>CGear </strong>pøedstavuje ukazatel zaøazené rychlosti a to je 
  jediná zásadní vìc, kterou tato tøída umoòuje nastavit pomocí funkce <strong>SetGear()</strong>. 
  Ukazatel rychlosti se nachází v levém dolním rohu obrazovky.</p>
<h5><a name="sec5.2.2.4"><strong>Tøída CPlaceList</strong></a></h5>
<p>Tøída <strong>CPlaceList </strong>pøedstavuje tabulku prùbìného poøadí v závodu. 
  Prùbìné hráèù se nastavuje pomocí funkce <strong>SetRaceState(). </strong>Je 
  zobrazováno vdy poøadí, jméno hráèe a nakonec poèet kol, které ji odjel. Tabulka 
  prùbìného poøadí se nachází v levém horním rohu.</p>
<h5><a name="sec5.2.2.5">Tøída CNowPlaying</a></h5>
<p>Tøída <strong>CNowPlaying </strong>poskytuje informace o momentálnì hrané písnièce. 
  Tyto informace se nastavují pomocí funkce <strong>SetNowPlayingText()</strong>. 
  Jedná se o jméno písnièky a název skupiny nebo zpìváka, kterı ji hraje. Toto 
  info se objevuje v pravém horním rohu urèitı èasovı interval po zaèátku písnièky.</p>
<h5><a name="sec5.2.2.6">Typickı zpùsob práce s HUDem</a></h5>
<ol>
  <li>HUD se nahraje ze souboru pomocí funkce <strong>LoadHUD()</strong></li>
  <li>HUD se zaregistruje v jádru HUDu pomocí funkce <strong>Register()</strong></li>
  <li>Jednotlivé prvky HUDu se pouívají, nastavuje se u nich, co je potøeba</li>
</ol>
<p class="center"><img src="images/HUDWork.png" width="640" height="36"></p>
<p class="center"><strong>Obrázek 5.7: Typickı zpùsob pouití HUDu</strong></p>
<h5><a name="sec5.2.2.7">Co by se dalo zlepšit</a></h5>
<p>Bohuel v momentální verzi HUDu není dovoleno hráèi pøeskupit si jednotlivé 
  prvky HUDu podle jeho uváení a to ani editací vstupního souboru nastavení HUDu. 
  Vzhledem k objemu práce na projektu nebyl èas tuto vlastnost HUDu implementovat. 
  Vyaduje to implementaci abstraktní vrstvy do tøídy <strong>CHUD</strong>, která 
  se postará o správné provázání jednotlivıch prvkù HUDu a správné poøadí registrace 
  do jádra HUDu.</p>
  
  <h2><a name="sec5.5">5.5 Hudba</a></h2>
<p>Hudba podtrhuje celkovı hráèùv proitek, zatahuje hráèe více do hry, èiní mu 
  hraní pøíjemnìjší. S pøihlédnutím, e s pomocí externích knihoven je dnes základní 
  hudební systém pomìrnì snadné implementovat, rozhodli jsme se implementovat 
  takovı jednoduchı hudební systém i do naší hry. Pouili jsme k tomu knihovnu 
  FMOD Ex od spoleènosti Firelight Technologies, která je volnì ke staení pro 
  nekomerèní úèely na <a href="www.FMOD.org">www.FMOD.org</a>.</p>
<p>Hudební systém v naší aplikaci reprezentuje tøída <strong>CSoundSystem</strong>, 
  která je souèástí klienta. </p>
<p>Tato tøída poskytuje následující monosti:</p>
<ol>
  <li>Náhodné pøehrávání hudby typu MP3 z pøedem nastaveného listu skladeb</li>
  <li>Informace o protagonistovi a názvu právì hrané skladby</li>
  <li>Monost upozornìní na to, e se hraje nová skladba a monost upozornìní 
    N sekund po startu hraní dané skladby</li>
</ol>
<h5><a name="sec5.3.1">Náhodné pøehrávání hudby typu MP3</a></h5>
<p>Pomocí funkce <strong>SetMusicList() </strong>se nastaví seznam skladeb, které 
  se mají v náhodném poøadí pøehrávat. Poté se pomocí funkce <strong>PlayMusic() 
  </strong>dá spustit samotné náhodné pøehrávání skladeb. Pomocí funkce <strong>PauseMusic() 
  </strong>se dá pøehrávání v libovolné chvíli pozastavit èi pokraèovat v pøedem 
  pozastaveném pøehrávání hudby. Funkce <strong>Update() </strong>musí bıt periodicky 
  volána, aby se zvukovı záznam, kterı je pøehrávanı stihl postupnì updatovat 
  do zvukového bufferu, z kterého se následnì posílá hudba na reproduktory. Internì 
  se o pøehrávání stará knihovna FMOD Ex. Pøehrává se zvukovı záznam (stream). 
  Jestlie nìjakou skladbu z daného seznamu nelze pøehrát, je ze seznamu hranıch 
  skladeb vyøazena. Seznam skladeb v naší aplikaci nastavuje <strong>Klient</strong> 
  za pomocí tøídy <strong>CGameInfo</strong>, která obsahuje seznam všech skladeb 
  s pøíponou <strong>*.MP3</strong> v adresáøi <strong>data/music </strong>a jejich 
  podadresáøích. </p>
<h5><a name="sec5.3.2">Informace o protagonistovi a názvu hrané skladby</a></h5>
<p>Informace o protagonistovi a názvu hrané skladby jsou k dispozici vdy k dané 
  skladbì, která se právì hraje. Dají se získat pomocí volání funkcí <strong>GetTitle() 
  </strong>a <strong>GetArtist()</strong>.</p>
<h5><a name="sec5.3.3">Monosti upozornìní na událost zaèátku nové skladby a událost N sekund po 
  zaèátku nové skladby</a></h5>
<p>Tato monost upozornìní byla pøidána zejména proto, aby bylo moné informovat 
  hráèe hrajícího hru o názvu a protagonistovi skladby.<strong> </strong>Tato 
  monost upozornìní je implementována pomocí callback funkcí. Klient si zaregistruje 
  dvì callback funkce. Jednu pro zaèátek nové skladby a druhou N sekund po zaèátku 
  nové skladby. Klient pak pøi kadém zaèátku nové skladby zobrazí prvek HUDu, 
  kterı zobrazuje informace o protagonistovi a hrané skladbì. Po uplynutí urèité 
  doby se zavolá druhá callback funkce, kde klient zobrazené informace o skladbì 
  zase skryje. Tím je zajištìno informování hráèe o názvu a protagonistovi 
  dané skladby. Callback funkce se registrují pomocí funkcí <strong>SetNewSongCallback()</strong> 
  a <strong>SetNewSongSecondsCallback()</strong>.</p>
<p class="center"><img src="images/SoundSystem.png" width="333" height="323"></p>
<p class="center"><strong>Obrázek 5.8: Schéma propojení hudebního systému s aplikací</strong></p>


</body>
</html>
