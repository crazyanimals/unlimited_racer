<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=windows-1250"/>
	<link type="text/css" href="mainstyles.css" rel="stylesheet"/>
	<title>Fyzikální engine</title>
</head>

<body>
<h1 id="section0">3 Fyzikální engine</h1>
<h2 id="section1">3.1 Seznámení s fyzikálním enginem</h2>
<p> Na úplném zaèátku projektu jsme byli postaveni pøed rozhodnutí, jakım zpùsobem se budou øešit vıpoèty pozic objektù ve høe. Z nìkolika monıch pøístupù jsme vybrali vıpoèty na základì fyzikálních zákonù. Toto rozhodnutí nám pøineslo na jedné stranì vıhodu realistické interakce objektù ve scénì, na druhé stranì urèité problémy. Tyto problémy èase vyvolaly nìkolik zásadních zmìn v samotném návrhu celého projektu.</p>
<h3 id="section1.1">3.1.1 Vlastní implementace a problémy s ní spojené</h3>
<p>Jak u jsme v úvodu zmínili, naše první kroky smìøovaly k pokusu o implementaci vlastního fyzikálního enginu. Po nastudování pøíslušné dokumentace byl vytvoøen návrh fyzikálního modulu. Ten je v podstatì totonı s tím, co obsahuje v souèasnosti. Pozdìji byly odstranìny pouze èásti tıkající se kolizí objektù a samotného vıpoètu, materiály byly vyèlenìny zvláš. V prùbìhu prací jsme došli k závìru, e doba potøebná na implementaci takto rozsáhlého øešení je mnohem delší, ne jsme pùvodnì pøedpokládali.</p>
<p>Navíc jsme si nemohli bıt jisti tím, e tento pøístup bude správnì a pøedevším dostateènì rychle pracovat. Zpodìní na fyzikálním modulu se vyvolalo kaskádovı efekt a postupnì se pøeneslo i na další projekty závislé na fyzice a ty se také zaèínaly opoïovat. V této dobì jsme tak museli rozhodnout o tom, kterım smìrem se náš projekt bude nadále ubírat. K dispozici jsme mìli dvì monosti - zmìnit pohled na fyzkální model nebo vyuít nìjakı hotovı fyzikální engine.</p>
<dl>
    <dt><strong>a) zmìna pohledu na fyzikálního modelu</strong></dt>
        <dd>+ vlastní implementace a s tím spojena monost kompletního ladìní</dd>
        <dd>- zjednodušení modelu - nìkteré ústupky od specifikace</dd>  
    <dt><strong>b) zachování stávajícího fyzikálního modelu</strong></dt>
        <dd>+ dodrení specifikace projektu, vìtší hratelnost</dd>
        <dd>+ fungující, dostateènì rychlı fyzikální engine</dd>
        <dd>- závislost na cizím øešení se všemi vıhodami a nevıhodami</dd>
</dl>        
<p>I pøes rizika spojená s pouitím cizího øešení jsme se rozhodli pro druhou monost. Prošli jsme nìkolik dostupnıch fyzikálních enginù. Nakonec jsme se rozhodli pro fyzikální engine <strong>Newton Game Dynamics<sup>TM</sup></strong>.</p>
<h3 id="section1.2">3.1.2 Integrace nového fyzikálního enginu</h3>
<p> <strong>Newton Game Dynamics<sup>TM</sup></strong> (dále jen <strong>NGD</strong>). Stránky tvùrcù: <a href="http://www.newtondynamics.com">www.newtondynamics.com</a></p>
<p>V této sekci se budeme zabıvat lehkım seznámením s enginem, s tím jak probíhala jeho integrace a s problémy spojenımi s pouíváním tohoto enginu. <strong>NGD</strong> je vcelku vyspìlı fyzikální engine. Pro náš projekt byly obzvláštì zajímavé tyto schopnosti:</p>
<ul>
    <li><strong>integrátor</strong> - ten obstarává vıpoèty fyziky</li>
    <li><strong>detekce kolizí</strong> - mechanismus, bez kterého se ádná fyzikální simulace neobejde</li>
    <li><strong>správa scény</strong> - pøístupy umoòující snadnou manipulaci s objekty ve scénì</li>
    <li><strong>kolizní obálky</strong> - bez nich by tìlesa byla pouhé hmotné body, na tìchto obálkách se detekují kolize</li>
    <li><strong>tìlesa</strong> - tìlesa, která spravuje engine, na kterıch provádí vıpoèty</li>
    <li><strong>materiály</strong> - monost definice rùznıch materiálù pro zvıšení realistiènosti simulace</li>
    <li><strong>modul pro tvorbu auta</strong> - tento modul zjednodušuje tvorbu auta, jde o systém pruin a kol</li>
</ul>
<p>Pøi integraci <strong>NGD</strong> enginu jsme museli provést nìkolik zmìn v našem dosavadním návrhu. Kosmetickımi úpravami se zde nebudeme zabıvat. Mezi nejvıznamnìjší zmìny patøi pøechod k pouívání transformaèních matic v grafice a síti a vytvoøení zvláštní materiálové tøídy. V pùvodním návrhu grafickı modul pracoval tak, e nastavoval pozice a rotace objektù pøímo pomocí vektorù a úhlù. S pøíchodem <strong>NGD</strong> bylo nutno pøejít k pouívání transformaèních matic. Èást grafického enginu musela bıt patøiènì upravena. Podobnımi zmìnami jako grafickı modul musela projít také daná èást síového modulu starající se o pøenost tìchto dat. Nutno poznamenat, e v tomto pøípadì šlo spíše o drobnosti. Druhá vıznamná zmìna se tıkala materiálù. Pro jejich pouití musela bıt vytvoøena nová tøída zajišující jejich správnou funkènost.</p>
<h3 id="section1.3">3.1.3 Problémy spojené s pøechodem</h3>
<p>Pøechod na <strong>NGD</strong> nepøinesl jenom klady. Objevilo se také nìkolik velmi nepøíjemnıch komplikací. Z moností nabízenıch <strong>NGD</strong> jsme museli vybrat jak budeme reprezentovat objekty ve scénì - pøesnìji øeèeno jejich kolizní obálky. U dynamickıch objektù a aut padla volba na pouívání konvexních obálek (<a href="#section2.2.1"><strong>Convex Hull Collisions</strong></a>). Pro statické objekty a terén byly vybrány obálky pro tvorbu sloitìjších statickıch objektù (<a href="#section2.2.2"><strong>Tree Collision</strong></a>). Asi nejvíce èasu jsme strávili s pokusy pøimìt obálky <strong>Tree Collision</strong> fungovat. Hlavním problém bylo propadávání objektù - zde nedocházelo k vzájemné interakci obálek, pøípadnì nefungovala vdy správnì. Hledáním pøíèiny této chyby jsme strávili pomìrnì znaèné mnotví èasu. Nakonec jsme uspìli na stránkách oficiálního fóra <a href="http://www.newtongamedynamics.com/forum/">www.newtondynamics.com/forum/</a>. Šlo o správné poøadí zadávání vrcholù - proti smìru hodinovıch ruèièek. O této malièkosti se ovšem autoøi v dokumentaci zapomnìli zmínit.</p>
<p>S propadáváním objektù "z neznámé pøíèiny" jsme se museli vypoøádat ještì jednou pøi zmìnách mìøítka objektù. Pøi pouití odpovídající transformaèní matice sice došlo ke správné zmìnì mìøítka u kolizní obálky, objekt však s ostatními objekty neinteragoval. V takovém pøípadì se musela nejdøíve zmìnit velikost celé kolizní obálky u pøi její tvorbì. Dále se pouívala transformaèní matice bez zmìny mìøítka - objekt u mìl potøebnou velikost. Grafickı engine potom tuto matici v pøípadì potøeby pøenásobil zleva maticí mìnící mìøítko.</p>
<p>Nìkolik nepøíjemností bylo spojeno s pouíváním starší verze enginu. Zde šlo pøedevším o potíe s obálkou terénu (o tom se podrobnìji pojednává v sekci zabıvající se <a href="#section3.2">terénem</a>) a modulem pro tvorbu aut. Auta byla velmi nestabilní, maximální hmotnost byla maximálnì 100 kg, kola èasto propadávala terénem. Nová verze enginu vyøešila vìtšinu tìchto problémù. Stále však èas od èasu dochází ke špatnım kolizím kol.</p>
<h2 id="section2">3.2 Fyzikální engine Newton Game Dynamics<sup>TM</sup></h2>
<p> Smyslem tohoto oddílu není pøesnı popis všech souèástí, spíše se jedná o vıèet vìcí, které povaujeme z programátorského hlediska za nejvıznamnìjší. Pøípadné zájemce o detailnìjší popis bychom odkázali na manuál dodávanı s enginem (ten je moné sehnat na stránkách autorù <a href="http://www.newtondynamics.com">www.newtondynamics.com</a>), pøípadnì na oficiální fórum <a href="http://www.newtondynamics.com/forum/">www.newtondynamics.com/forum/</a> (odkud jsme èerpali informace také my).</p>
<h3 id="section2.1">3.2.1 Struktura NewtonWorld</h3>
<p><strong>NewtonWorld</strong> je hlavní struktura v enginu <strong>NGD</strong>. <strong>NewtonWorld</strong> pøedstavuje svìt z pohledu <strong>NGD</strong>, v jeho rámci pak probíhají vıpoèty. Všechny další novì vytvoøené struktury pøísluší nìjakému svìtu.</p>
<dl>
    <dt><span>Vıbìr vıznamnıch funkcí:</span></dt>
        <dd><strong>NewtonSetSolverModel()</strong> - nastavení pøesnosti a rychlosti integrátoru</dd>
        <dd><strong>NewtonSetFrictionModel()</strong> - nastavení pøesnosti modelu pouitého pøi vıpoètu tøení</dd>
        <dd><strong>NewtonUpdate()</strong> - provedení simulace za uivatelem zadanı èasovı interval</dd>
        <dd><strong>NewtonSetWorldSize()</strong> - vymezení svìta, veškeré simulace probíhají pouze v rámci takto vymezeného svìta</dd>
        <dd><strong>NewtonWorldRayCast()</strong> - vrhnutí paprsku z bodu do bodu, obslouení uivatelem definovanou funkcí</dd>
</dl>
<h3 id="section2.2">3.2.2 Struktura NewtonCollision</h3>
<p> Vyuití struktury <strong>NewtonCollision</strong> spoèívá v reprezentaci kolizních obálky pouívanıch enginem <strong>NGD</strong>. <strong>NGD</strong> umoòuje tvorbu nìkolika typù obálek - konvexní obálky, obálky pro statické objekty a uivatelem definované obálky. My jsme pouívali první dva typy.</p>
<h4 id="section2.2.1">3.2.2.1 Kolizní obálka typu Convex Hull Collision</h4>
<p>Konvexní obálka se v <strong>NGD</strong> pouívá na dynamické objekty. V našem pøípadì jsme zvolili monost vytvoøení konvexní obálky na základì skupiny vrcholù.</p>
<dl>
    <dt><span>Vıbìr vıznamnıch funkcí:</span></dt>
        <dd><strong>NewtonCreateConvexHull()</strong> - tvorba konvexní obálky na základì skupiny vrcholù</dd>
        <dd><strong>NewtonConvexCollisionCalculateInertialMatrix()</strong> - vıpoèet momentù setrvaènosti a umístìní tìištì</dd>
</dl>
<h4 id="section2.2.2">3.2.2.2 Kolizní obálka typu Tree Collision</h4>
<p><strong>Tree Collision</strong> pøedstavuje preferovanı zpùsob tvorby kolizní obálky pro statické objekty. Tvorba probíhá pøidáváním polygonù. U objektù, které pouívají tento typ obálky, je ignorována hmotnost ve všech dynamickıch vıpoètech.</p>
<dl>
    <dt><span>Vıbìr vıznamnıch funkcí:</span></dt>
        <dd><strong>NewtonCreateTreeCollision()</strong> - tvorba obálky pro statické objekty</dd>
        <dd><strong>NewtonTreeCollisionBeginBuild()</strong> - zaèátek tvorby obálky</dd>
        <dd><strong>NewtonTreeCollisionAddFace()</strong> - pøidání nového polygonu do obálky</dd>
        <dd><strong>NewtonTreeCollisionEndBuild()</strong> - konec tvorby obálky</dd>
</dl>
<h3 id="section2.3">3.2.3 Struktura NewtonBody</h3>
<p>Struktura <strong>NewtonBody</strong> reprezentuje tìlesa, na kterıch se provádìjí fyzikální vıpoèty. Pøi tvorbì je takovému tìlesu pøiøazena kolizní obálka. <strong>NewtonBody</strong> umoòuje provádìt velké mnoství operací napø. manipulace se silami a momenty sil.</p>
<dl>
    <dt><span>Vıbìr vıznamnıch funkcí:</span></dt>
        <dd><strong>NewtonCreateBody()</strong> - tvorba nového tìlesa, pøiøazení kolizní obálky</dd>
        <dd><strong>NewtonBodySetTransformCallback()</strong> - pøiøazení obsluné funkce, je automaticky zavolána pøi zmìnì polohy tìlesa v prùbìhu vıpoètu</dd>
        <dd><strong>NewtonBodySetForceAndTorqueCallback()</strong> - pøiøazení obsluné funkce, ta je volána v kadém kroku vıpoètu</dd>
        <dd><strong>NewtonBodySet/GetMassMatrix()</strong> - nastavení/získání hmotnosti tìlesa</dd>
        <dd><strong>NewtonBodySet/GetMatrix()</strong> - nastavení/získání transformaèní matice tìlesa</dd>
        <dd><strong>NewtonBodySet/GetCentreOfMass()</strong> - nastavení/získání polohy tìištì tìlesa</dd>
        <dd><strong>NewtonBodySet/Add/GetForce()</strong> - nastavení/pøidání/získání síly pùsobící na tìleso</dd>
        <dd><strong>NewtonBodySet/Add/GetTorque()</strong> - nastavení/pøidání/získání momentu sil pùsobícího na tìleso</dd>
        <dd><strong>NewtonBodySet/GetMaterialGroupID()</strong> - nastavení/získání indexu materiálové skupiny</dd>
</dl>
<h3 id="section2.4">3.2.4 Struktura NewtonJoint</h3>
<p> Klouby (spojení tìles) jsou v enginu <strong>NGD</strong> tvoøeny pomocí struktury <strong>NewtonJoint</strong>.  My jsme vyuili typ spojení v modulu pro tvorbu aut.</p>
<dl>
    <dt><span>Vıbìr vıznamnıch funkcí:</span></dt>
        <dd><strong>NewtonConstraintCreateVehicle()</strong> - vytvoøení spojení bez kol, jde o zjednodušenı model pøipojení kola k autu a tlumièù, kola se mohou otáèet</dd>
        <dd><strong>NewtonVehicleSetTireCallback()</strong> - pøiøazení obsluné funkce, je volána v kadém kroku vıpoètu</dd>
        <dd><strong>NewtonVehicleAddTire()</strong> - pøidání nového kola</dd>
        <dd><strong>NewtonVehicleGetTireMatrix()</strong> - získání transformaèní matice kola</dd>
        <dd><strong>NewtonVehicleSet/GetTireSteerAngle()</strong> - nastavení/získání úhlu kola - simulace zatáèení</dd>
        <dd><strong>NewtonVehicleSetTireTorque()</strong> - nastavení momentu sil pùsobícího na kolo</dd>
        <dd><strong>NewtonVehicleGetTireOmega()</strong> - získání úhlové rychlosti pùsobící na kolo</dd>
</dl>
<h3 id="section2.5">3.2.5 Struktura NewtonMaterial</h3>
<p> Materiály jsou v enginu <strong>NGD</strong> simulovány pomocí grafu, kde vrcholy jsou jednotlivé materiály. Hrana mezi dvìma vrcholy pøedstavuje pár materiálù - struktura <strong>NewtonMaterial</strong>. Takto je umonìno nastavovat rùzné vlastnosti od prunosti po koeficienty tøení.</p>
<dl>
    <dt><span>Vıbìr vıznamnıch funkcí:</span></dt>
        <dd><strong>NewtonMaterialGetDefaultGroupID()</strong> - získání indexu základní materiálové skupiny</dd>
        <dd><strong>NewtonMaterialCreateGroupID()</strong> - vytvoøení materiálové skupiny</dd>
        <dd><strong>NewtonMaterialSetDefaultCollidable()</strong> - nastavení vlastnosti kolize</dd>
        <dd><strong>NewtonMaterialSetDefaultFriction()</strong> - nastavení koeficientù statického a dynamického tøení</dd>
        <dd><strong>NewtonMaterialSetDefaultElasticity()</strong> - nastavení prunosti</dd>
        <dd><strong>NewtonMaterialSetCollisionCallback()</strong> - pøiøazení obsluné funkce, je volána pøi kontaktu dvou tìles</dd>
</dl>
<h2 id="section3">3.3 Fyzikální engine pro hru Unlimited Racer</h2>
<p>V této èásti dokumentace se budeme vìnovat celkovému pohledu na fyzikální engine pouitı ve høe. Popíšeme si vìci, ze kterıch se skládá fyzikální scéna, to jak fungují materiály a podíváme se na dìje spojené s inicializací a samotnım prùbìhem simulace. V závìru se budeme zabıvat vnitøním objektovım návrhem fyzikálního modulu.</p>
<p>Fyzikální scéna se skládá z nìkolika èástí. Nachází se zde <a href="#section3.1.1">statické</a> a <a href="#section3.1.2">dynamické</a> objekty. Dalším dùleitım prvkem ve scénì je <a href="#section3.2">terén</a>. Terén se skládá z jednoho velkého, pøípadnì skupiny statickıch objektù - oba pøístupy je moné pouít. Posledním prvkem figurujícím ve fyzikální scénì jsou vozidla. Jedná se o speciální dynamickı objekt skládající se z <a href="#section3.3.1">karoserie</a>, <a href="#section3.3.2">kol</a> a <a href="#section3.3.3">motoru</a>.</p>
<h3 id="section3.1">3.3.1 Objekty</h3>
<p>Objekty ve høe rozlišujeme na dva druhy - <a href="#section3.1.1">statické</a> a <a href="#section3.1.2">dynamické</a>. Existuje hned nìkolik dùvodu, proè je bylo nutné rozlišit. Dva hlavní dùvody jsou odlišnı zpùsob tvorby kolizní obálky a sníení vıpoèetní nároènosti fyzikální scény.</p>
<h4 id="section3.1.1">3.3.1.1 Statické objekty</h4>
<p>Statické objekty ve scénì zastupují nehybné objekty. Ve høe plní rùzné funkce - od pøekáek na jedìní (looping, rùzné rampy, klopené zatáèky) a po doplòkové objekty (billboardy, lampy). Uivateli zde byla ponechána znaèná volnost v tom, jaké objekty do hry umístí. Objektùm je také moné pøiøadit nìkterı z uivatelem vytvoøenıch materiálù. V pøípadì, e ádnı materiál není nastaven pouije se základní materiál zabudovanı ve høe.</p>
<p>Z pohledu fyzikálního enginu je statickı objekt tvoøen kolizní obálkou, jeho hmotnost je ignorována ve všech vıpoètech. Tato obálka je nejèastìji vytvoøena na základì modelu tìlesa, které má reprezentovat. Tvorba kolizní obálky probíhá po jednotlivıch polygonech - to je dáno díky vlastnostem <strong>NGD</strong> (pouívá se obálka typu <a href="#section2.2.2"><strong>Tree Collision</strong></a>).</p>
<p class="center"><img src="images/TreeCollision.gif" width="417" height="204" alt="Tvorba kolizní obálky pro statické objekty"/></p>
<p class="center"><strong>Obrázek 3.1: Tvorba kolizní obálky pro statické objekty</strong></p>
<p>Jak u bylo øeèeno døíve, u statickıch objektù se nebere v úvahu jejich hmotnost (proto ji není nutné uvádìt). Díky tomu jsou mnohem ménì nároèné na vıpoèty. Navíc se pozice statickıch objektù urèuje pouze jednou pøi inicializaci nové hry. Tím nezatìují síovou komunikace, protoe se v prùbìhu simulace nepohybují.</p>
<h4 id="section3.1.2">3.3.1.2 Dynamické objekty</h4>
<p>Dynamické objekty se mohou v prùbìhu simulace pohybovat. Jejich funkce vìtšinou spoèívá v menších doplòkovıch objektech jako jsou rùzné kuely, barely nebo prkna. Podobnì jako u statickıch objektù i zde je rozhodnutí zcela na uivateli - a u jde o druh objektu nebo o materiál.</p>
<p>Pøi tvorbì kolizních obálek se dynamické objekty odlišují hned v nìkolika záleitostech. Obálka je vytvoøena obvykle na základì modelu vygenerováním konvexního obalu (obálka typu <a href="#section2.2.1"><strong>Convex Hull Collision</strong></a>).</p>
<p class="center"><img src="images/ConvexHullCollision.gif" width="512" height="206" alt="Tvorba kolizní obálky pro dynamické objekty"/></p>
<p class="center"><strong>Obrázek 3.2: Tvorba kolizní obálky pro dynamické objekty</strong></p>
<p>Zpracování velkého mnoství dynamickıch objektù vıznamnì zpomaluje jak fyzkální vıpoèty tak síovou komunikaci. Tyto problémy øeší jejich rozdìlení na dvì skupiny - aktivní a neaktivní. V praxi se to projevuje tak, e v kadém kroku jsou do vıpoètu zahrnuty pouze aktivní objekty. Objekty v prùbìhu simulace pøecházejí mezi tìmito dvìma stavy. Neaktivní stav je dosaen ustálením ve své poloze. Aktivaci mùe zpùsobit kolize s pohybujícím se objektem. Zmìnu stavu je samozøejmì moné ovlivnit i manuálnì. Toto rozdìlení urychluje vıpoèet. U neaktivních objektù pak odpadá nutnost neustálého posílání pozic.</p>
<h3 id="section3.2">3.3.2 Terén</h3>
<p>Terén je patrnì nejdùleitìjší souèást našeho herního svìta. Veškeré dynamické objekty a vozidla témìø neustále kolidují s terénem. Budeme-li terén posuzovat z pohledu enginu <strong>NGD</strong>, jedná se o jeden velkı statickı objekt. Celı terén je sloen ze skupiny ètvercovıch políèek o délce strany 1000 jednotek (pøi souèasném nastavení je to pøesnì 10 metrù). Tato jednotlivá políèka jsou tvoøena z pøedem vygenerovanıch terénních plátù.</p>
<p>Kolizní obálka terénu je zaloena na vıše zmínìnıch terénních plátech. Velikost obálky (mínìno co do poètu polygonù) se v prùbìhu projektu nìkolikrát mìnila. V první verzi byl terén vytvoøen najednou - tedy jeden velkı objekt. Ten vznikal tak, e se postupnì procházela políèka na mapì. Pro kadé políèko byl nalezen pøíslušnı terénní plát a polygony, z kterıch se skládal, byly pøidány k obálce. V dùsledku pouívání starší verze knihovny enginu <strong>NGD</strong> docházelo k problémùm s pamìtí a souèasnì tvorba obálky mìla vìtší èasovou nároènost.</p>
<p>V dùsledku tìchto problémù došlo k pøepracování zpùsobu tvorby kolizní obálky. Pùvodní koncepce zaloená na jednom velké objektu byla zahozena a pøešlo se k pouívání menších kusù. Kadé políèko na mapì pøedstavovalo jeden statickı objekt - tj. mapa o velikosti 10 x 10 byla sloena ze 100 statickıch objektù ètvercového pùdorysu s délkou strany 10 metrù. Vytváøení kolizní obálky pro kadé políèko by zabralo pomìrnì hodnì èasu. Aby se pøedešlo podobnım problémùm, byly nejprve vytvoøeny obálky pro všechny typy terénních plátù pouívanıch v nahrávané mapì. V dalším kroku u staèilo pouze vytváøet objekty a pøiøazovat k nim odpovídající kolizní obálky. Nevıhoda tohoto pøístupu spoèívala ve vyšších pamìovıch nárocích. Ty byly zpùsobeny vnitøní reií <strong>NGD</strong>.</p>
<p>Pøed poslední zmìna byla provedena na základì testování aut. Pøi jízdì docházelo k èastému poskakování právì v místì pøechodu mezi jednotlivımi objekty tvoøícími terén. Toto zjištìní si vyádalo pøepracování tvorby terénu. Mapa byla rozdìlena na nìkolik ètvercovıch oblastí - skupin terénních plátù. Tím se sníil poèet pøechodù. Tvorba terénu probíhala procházením všech skupin v mapì a pøidáváním terénních plátù do kolizní obálky skupiny (viz obrázek). Tento zpùsob tvoøil jakısi kompromis mezi obìma døíve pouitımi pøístupy.</p>
<p class="center"><img src="images/TerrainCreation.gif" width="711" height="216" alt="Zpùsob tvorby terénu pomocí skupin terénních plátù"/></p>
<p class="center"><strong>Obrázek 3.3: Zpùsob tvorby terénu pomocí skupin terénních plátù</strong></p>
<p>Poslední verze knihovny <strong>NGD</strong> opravila mnoho problémù tıkajících se tvorby obálek statickıch objektù. Odpadly jak problémy s maximální velikostí obálky tak delší èasy pøi jejich tvorbì. Tyto zmìny umonily opìt pouívat pro terén jednu velkou kolizní obálku. Díky pouívání skupin terénních plátù v posledním návrhu nebylo nutné provádìt zmìny v algoritmu. Nyní probíhá tvorba terénu z jedné skupiny pokrıvající celou mapu.</p>
<h3 id="section3.3">3.3.3 Auta</h3>
<p>Auta patøí mezi pohyblivé objekty ve fyzikální scénì - mají vìtšinu vlastností podobnıch jako dynamické objekty, souèasnì se odlišují v celé øadì vìcí. Geometrie vozidla se skládá ze dvou typù obálek - karoserie a kola. Karoserie s koly drí pohromadì speciální spoj s pruinou. Tímto zpùsobem je mono simulovat tlumièe, které se pouívají ve skuteènıch automobilech. Obálky karoserie a kol spolu vzájemnì neinteragují. Vedle tìchto èástí obsahuje model auta ještì jeden objekt - motor. Z pohledu fyziky se jedná o èistì virtuální tìleso, které nezasahuje do fyzikálních vıpoètù, a jeho jedinım úèelem je simulace základních funkcí skuteèného motoru.</p>
<p></p>
<h4 id="section3.3.1">3.3.3.1 Karoserie</h4>
<p>Karoserii auta mùeme zaøadit mezi dynamické objekty ve scénì. Obálka je vytvoøena na základì modelu karoserie vygenerováním konvexního obalu (obálka typu <a href="#section2.2.1"><strong>Convex Hull Collision</strong></a>). Vìtšinu parametrù urèujících nìkteré vlastosti dynamickıch objektù je nutné nastavit i v tomto pøípadì. Vozidla jsou na rozdíl od dynamickıch objektù obvykle po celou dobu vıpoètu v pohybu, proto bylo nutné zrušit schopnost vozidla pøecházet mezi aktivním a neaktivním stavem.</p>
<h4 id="section3.3.2">3.3.3.2 Kola</h4>
<p>Kola vozidel jsou vytváøena automaticky enginem <strong>NGD</strong> na základì uivatelem zadanıch hodnot - šíøka a polomìr. Kolizní obálku vygeneruje engine a ta pak vyplòuje, pøípadnì lehce obaluje celé kolo. Podobnì jako karoserie i kola mùeme povaovat za dynamické objekty, které jsou stále aktivní. Jak u bylo øeèeno døíve, kola jsou pøipojená ke karoserii pomocí pruin. Tyto pruiny jsou popsány pomocí tìchto vlastností - délka, tuhost a útlum.</p>
<p>Upevnìní kol umoòuje celou øadu pohybù. Jedním z nich je posuvnı pohyb podél osy definované pruinou. Okolo této osy je rovnì nastavováno zatoèení kol kvùli zmìnì smìru jízdy. Nastavování úhlù kol je zaloena na principu tzv. Ackermanova øízení. Jedná se o pøístup, kdy osy otáèení všech kol se protínají v jednom bodì - støedu otáèení. Tímto zpùsobem je moné dosáhnou lepších vlastností vozidel pøi zatáèení.</p>
<p class="center"><img src="images/Ackerman.gif" width="285" height="174" alt="Princip Ackermanova øízení"/></p>
<p class="center"><strong>Obrázek 3.4: Princip Ackermanova øízení</strong></p>
<p>Posledním pohybem kola je otáèení okolo osy kolmé na smìr jízdy a osu pruiny. Kolo se kolem této osy mùe volnì otáèet. Auto se uvádí do pohybu zvìtšováním momentu sil pùsobícím na kolo, obdobnım zpùsobem je vyvoláno brdìní.</p>
<h4 id="section3.3.3">3.3.3.3 Motor</h4>
<p>V naší høe je skuteènı model zastoupen vıraznì zjednodušenou verzí pracující na principu vyhledávání otáèek na vıkonové køivce. Pøi inicializace hry (závody) jsou z uivatelem nastavenıch hodnot zjištìny rychlostní stupnì a jednotlivé body vıkonové køivky. Vstupním parametrem pro urèení odpovídajícího momentu sil je úhlová rychlost kol. Ta je pøevedena na poèet otáèek motoru za minutu. Kadá nová hodnota je poupravena, pokud pøesahuje maximální a minimální otáèky motoru. Aby se pøedešlo velkım vıkyvùm otáèek motoru, je tato hodnota prùmìrována z nìkolika po sobì jdoucích. Ve vıkonové køivce se potom na základì otáèek motoru za minutu vyhledá odpovídajicí moment sil, kterı je aplikován na kola.</p>
<h3 id="section3.4">3.3.4 Materiály</h3>
<p>Pouívání materiálù vıraznì rozšiøuje monosti fyzikálního enginu. Pøi troše experimentování lze docílit velmi zajímavıch vısledkù. Nejprve je nutné seznámit se s tím, jak k materiálùm pøistupuje engine <strong>NGD</strong>. Z jeho úhlu pohledu je to graf, kde vrcholy jsou jednotlivé typy materiálù. Vlastnosti - prunost, mìkkost, koeficienty statického a dynamického tøení a schopnost kolize (pøesnìji - zda dva pøedmìty nesoucí danou dvojici materiálù spolu kolidují, èi nikoliv) - se pak nastavují vdy pro urèitı pár materiálù. V praxi to pak vypadá tak, e se nejprve nastaví vlastnosti pro jeden základní materiál. To samé se potom provede s vybranımi páry dalších materiálù. Není nutné definovat všechny moné dvojice, dokonce není tøeba nastavit všechny vlastnosti. V takovém pøípadì je vyuit základní materiál.</p>
<p class="center"><img src="images/NewtonMaterials.gif" width="701" height="351" alt="Materiály z pohledu fyzikálního enginu Newton Game Dynamics TM"/></p>
<p class="center"><strong>Obrázek 3.5: Materiály z pohledu fyzikálního enginu Newton Game Dynamics<sup>TM</sup></strong></p>
<p id="section3.4.1">Poslední vìc, kterou má <strong>NGD</strong> k dispozici pro práci s materiály, je monost definování 3 obslunıch funkcí (nazvìme je <strong>collisionBegin()</strong>, <strong>processContact()</strong>, <strong>collisionEnd()</strong>). Zpùsob jejich pouívání je spojen s tím, jakım zpùsobem <strong>NGD</strong> zpracovává kolize. Pøi pøekrytí AABB obálek (osovì orientované obálky) dvou objektù se nejprve ovìøí, zda mezi nimi mùe dojít ke kolizi. To záleí na nastavení materiálù - kolize se mùe zpracovat a nebo také zahodit. Pøi zpracování se nejdøíve zavolá collisionBegin(). V ní je moné rozhodnout o dalším pokraèování. V kladném pøípadì se provede vıpoèet, jsou nalezeny kontaktní body a na kadı je zavolána funkce <strong>processContact()</strong>. Po zpracování všech kontaktù <strong>NGD</strong> zavolá funkci <strong>collisionEnd()</strong> - tím je ukonèeno zpracování kolize. Na pøiloeném diagramu je znázornìn prùbìh celého algoritmu.</p>
<p class="center"><img src="images/CollisionAlgorithm.gif" width="653" height="256" alt="Prùbìh algoritmu, kterı zpracovává kolizi objektù"/></p>
<p class="center"><strong>Obrázek 3.6: Prùbìh algoritmu, kterı zpracovává kolizi objektù</strong></p>
<p>Náš pøístup k materiálùm je ponìkud odlišnı. Je zaloen na 4 druzích materiálovıch typù, tabulce materiálù a materiálové mapì pro terén.
Pøi startu aplikace je naèten soubor <a href="FileSystem.html#materials">"Data\Physics\materials"</a>. Ten obsahuje seznam všech pouitıch materiálù a uivatelem nadefinované kombinace rùznıch materiálù. Tato data se uloí do dvourozmìrné tabulky, kde kadé pole pøedstavuje kombinaci dvou materiálù. Pøi spuštìní hry je pro zadanou mapu vytvoøena materiálová mapa. Kadı terénní plát je pokryt <a href="FileSystem.html#PhTexture">fyzikální texturou</a> o velikosti 10 x 10 polí tvoøenou indexy pouívanıch materiálù. Pøi naèítání objektù dojde k pøekrytí nìkterıch míst fyzikální texturou silnice.</p>
<p class="center"><img src="images/PhysicalTexture.gif" width="644" height="228" alt="Pøíklad fyzikální textury terénu, silnice a jejich kombinace"/></p>
<p class="center"><strong>Obrázek 3.7: Pøíklad fyzikální textury terénu, silnice a jejich kombinace</strong></p>
<p>V prùbìhu hry jsou pak vyuívány pouze 4 druhy materiálovıch typù - <strong>Základní</strong>, <strong>Auto</strong>, <strong>Objekt</strong> a <strong>Terén</strong>. Jejich název urèuje k jakému typu objektu ve scénì jsou pøiøazeny. Fyzikální vlastnosti mezi tìmito typy jsou definovány pouze na základním materiálovém typu. Typy se vzájemnì liší pouze ve funkcích zpracovávajících jednotlivé kontakty. Jde o funkce typu <strong>processContact()</strong>. My vyuíváme 4 odlišné funkce (viz obrázek): <strong>Auto_Objekt_Kontakt</strong>, <strong>Auto_Terén_Kontakt</strong>, <strong>Objekt_Objekt_Kontakt</strong> a <strong>Objekt_Terén_Kontakt</strong>.</p>
<p class="center"><img src="images/ProcessContactFunctions.gif" width="719" height="247" alt="Graf materiálovıch typù a funkcí typu processContact()"/></p>
<p class="center"><strong>Obrázek 3.8: Graf materiálovıch typù a funkcí typu processContact()</strong></p>
<p>Zpracování tìchto funkcí je zaloeno na hledání v tabulce materiálù. Pøi neúspìchu jsou pouity hodnoty definované pro dvojici základních materiálù. V prùbìhu volání funkce jsou získány dva indexy. Zpùsob urèení indexu záleí na materiálovém typu. Objekty mají jeden index, u aut se vdy rozlišuje mezi karoserií a koly. Index pro terén se hledá v materiálové mapì. V pøípadì úspìchu jsou nastaveny nové vlastnosti platné pro kolidující dvojici materiálù. Na obrázku je znázornìno volání funkce <strong>Auto_Terén_Kontakt</strong>.</p>
<p class="center"><img src="images/Car_Terrain_Contact.gif" width="644" height="238" alt="Zpùsob volání funkce Auto_Terén_Kontakt"/></p>
<p class="center"><strong>Obrázek 3.9: Zpùsob volání funkce Auto_Terén_Kontakt</strong></p>
<h3 id="section3.5">3.3.5 Prùbìh vıpoètu</h3>
<p>Vıpoèet probíhá v rámci hlavní metody <strong>Update()</strong> tøídy <strong>CPhysics</strong>. Tato metoda je volána v serveru v metodì <strong>CServer::updateGame()</strong>. Pomocí parametru je dodán èasovı interval. Ten je zajištìn pomocí èasovaèe. Vše probíhá tak, e se vdy zjistí aktuální èas a ten se odeète od èasu zaèátku minulého vıpoètu. Jejich rozdíl je pøedán metodì <strong>CPhysics::Update()</strong>. Aktuální èas je uloen a je pouit v dalším volání. Tento èasovaè zasílá pomìrnì velké èasové úseky (obèas i v øádu sekund). Proto je tento interval rozdìlen uvnitø metody <strong>CPhysics::Update()</strong> na vìtší poèet èasovıch úsekù stejné délky. Na kadı takovı úsek je zavolána funkce enginu <strong>NGD</strong> <strong>NewtonUpdate()</strong>. Tím je docíleno toho, e vıpoèet fyziky probíhá stabilnì po krocích stejné délky.</p>
<p>Vıpoèet fyzikální simulace je zajišován funkcí <strong>NewtonUpdate()</strong>. Kadé volání je rozdìleno do nìkolika fází. Nejdøíve probìhne detekce kolizí. Její prùbìh je podrobnìji popsán v sekci <a href="#section3.4.1"><strong>Materiály</strong></a>. Nalezené kolize jsou vyøešeny. V další fázi jsou na kadé aktivní tìleso aplikovány obsluné funkce, které urèí jaké síly a momenty sil v daném kroku na tìlesa pùsobí. U dynamickıch objektù se jedná o gravitaèní sílu, u aut se k tomu pøidává napøíklad vıpoèet odporové síly vzduchu nebo vıpoèet vıkonové køivky motoru. Na základì tìchto nastavení jsou integrátorem spoèítány nové pozice objektù. Na pøiloeném obrázku je znázornìn prùbìh volání obsluné funkce pro auto.</p>
<p class="center"><img src="images/CCar_ApplyForceAndTorque_Callback.gif" width="620" height="143" alt="Prùbìh volání obsluné funkce pro auto - CCar::ApplyForceAndTorque_Callback()"/></p>
<p class="center"><strong>Obrázek 3.10: Prùbìh volání obsluné funkce pro auto - CCar::ApplyForceAndTorque_Callback()</strong></p>
<p>Pøi tvorbì aplikace jsme se potıkali s rùznımi problémy. A u šlo o propadávání objektù nebo špatné kolizní obálky, byl zde vdy problém jak tyto vìci ladit. Jedinım monım øešením bylo zavést zobrazování kolizních obálek všech objektù. jedná se èistì o ladicí informaci s její pomocí si uivatel mùe prohlédnout, jakım zpùsobem jsou ve fyzikální scénì reprezentovány objekty. Zobrazování kolizní geometrie se nenacházelo v pùvodních návrzích projektu a bylo pøidáno do ji fungující aplikace. Vedlejším efektem je pomìrnì znaènı pokles vıkonu celé aplikace pøi jejich vykreslování. Pøi zpracování jednoho tìlesa zde dochází k prùchodu všech polygonù tvoøících obálku a k pøedání jeho vrcholù grafickému enginu. To zpùsobuje znaèné zpomalení, protoe grafika nemá pøímı pøístup ke geometrii tìles.</p>
<h2 id="section4">3.4 Pøehled tøíd</h2>
<p>Programovı modul fyziky tvoøí objektovou nádstavbu enginu <strong>NGD</strong>. Je sloen z nìkolika tøíd, jejich vzájemnı vztah je vidìt na pøiloeném diagramu.</p>
<p class="center"><img src="images/Physics.gif" width="663" height="729" alt="Vztahy mezi tøídami ve fyzikálním modulu"/></p>
<p class="center"><strong>Obrázek 3.11: Vztahy mezi tøídami ve fyzikálním modulu</strong></p>
<dl>
    <dt><strong>CPhysics</strong></dt>
        <dd>
            <ul>
                <li>hlavní tøída fyzikálního modulu, obsahuje ostatní tøídy aktivní za bìhu programu</li>
                <li>komunikuje s ostatními moduly - jedná se o síovı modul (serverová èást) a modul umìlé inteligence</li>             
                <li>stará se o inicializaci, bìh a ukonèení fyzikálního modulu</li>
                <li>umoòuje provádìt vykreslování kolizních obálek - voláním grafickıch metod</li>
                <li>instance této tøídy je aktivní po celou dobu bìhu programu</li>
            </ul>
        </dd>
    <dt><strong>CResources</strong></dt>
        <dd>
            <ul>
                <li>obsahuje indexy do Resource Manageru všech naètenıch dat</li>
                <li>pøi inicializaci hry obsahuje kolizní obálky všech dynamickıch a statickıch objektù a vozidel</li>
                <li>naèítá modely a vytváøí jejich kolizní obálky</li>
                <li>instance této tøídy je aktivní po celou dobu bìhu programu</li>
            </ul>
        </dd>
    <dt><strong>CMaterials</strong></dt>
        <dd>
            <ul>
                <li>obsahuje vlastnosti materiálù a tabulku materiálù</li>
                <li>jsou zde definovány obsluné funkce volané pøi kolizi objektù</li>
                <li>instance této tøídy je aktivní po celou dobu bìhu programu</li>
            </ul>
        </dd>
    <dt><strong>CTerrain</strong></dt>
        <dd>
            <ul>
                <li>reprezentuje terén ve fyzikální scénì</li>
                <li>obsahuje materiálovou mapu terénu</li>
                <li>obsahuje kolizní obálku pokrıvající celou fyzikální scénu (objekt <strong>CPhysicsPlate</strong>)</li>                
                <li>instance této tøídy je aktivní za bìhu hry</li>
            </ul>
        </dd>
    <dt><strong>CPhysicsPlate</strong></dt>
        <dd>
            <ul>
                <li>obsahuje kolizní obálku skupiny terénních plátù</li>
                <li>s pouitím <strong>CPhysicsSurface</strong> vytváøí kolizní obálku</li>
                <li>instance této tøídy jsou aktivní pøi inicializaci hry</li>
            </ul>
        </dd>
    <dt><strong>CPhysicsSurface</strong></dt>
        <dd>
            <ul>
                <li>obsahuje geometrii jednoho terénního plátu</li>
                <li>instance této tøídy jsou aktivní pøi inicializaci hry</li>
            </ul>
        </dd>
    <dt><strong>CRigidBody</strong></dt>
        <dd>
            <ul>
                <li>tato tøída je virtuální - jejími potomky jsou <strong>CWheel</strong>, <strong>CCar</strong> a <strong>CObject</strong></li>
                <li>obsahuje všechny základní vlastnosti kadého objektu ve fyzikální scénì</li>
            </ul>
        </dd>
    <dt><strong>CWheel</strong></dt>
        <dd>
            <ul>
                <li>reprezentuje kolo ve fyzikální scénì</li>
                <li>obsahuje metody zajišující funkènost kola - zatáèení, brdìní, odpor</li>
                <li>instance této tøídy jsou aktivní za bìhu hry</li>
            </ul>
        </dd>
    <dt><strong>CCar</strong></dt>
        <dd>
            <ul>
                <li>reprezentuje auto ve fyzikální scénì</li>
                <li>skládá se ze dvou vıznamnıch tøíd - <strong>CEngine</strong> a <strong>CWheel</strong></li>
                <li>obsahuje metody zajišující funkènost celého vozidla</li>
                <li>instance této tøídy jsou aktivní za bìhu hry</li>
            </ul>
        </dd>    
    <dt><strong>CEngine</strong></dt>
        <dd>
            <ul>
                <li>reprezentuje motor</li>
                <li>obsahuje metody zajišující funkènost motoru - øazení, vıkonovou køivku</li>
                <li>instance této tøídy jsou aktivní za bìhu hry</li>
            </ul>
        </dd>
    <dt><strong>CObject</strong></dt>
        <dd>
            <ul>
                <li>tato tøída je virtuální - jejími potomky jsou <strong>CStaticObject</strong> a <strong>CDynamicObject</strong></li>
            </ul>
        </dd>
    <dt><strong>CDynamicObject</strong></dt>
        <dd>
            <ul>
                <li>reprezentuje dynamickı objekt ve fyzikální scénì</li>
                <li>instance této tøídy jsou aktivní za bìhu hry</li>
            </ul>
        </dd>
    <dt><strong>CStaticObject</strong></dt>
        <dd>
            <ul>
                <li>reprezentuje statickı objekt ve fyzikální scénì</li>
                <li>instance této tøídy jsou aktivní za bìhu hry</li>
            </ul>
        </dd>                                                              
</dl>
</body>
</html>