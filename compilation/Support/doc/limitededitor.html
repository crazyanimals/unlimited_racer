<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=windows-1250">
	<link type="text/css" href="mainstyles.css" rel="stylesheet">
	<title>Programátorská dokumentace pro Limited Editor</title>
</head>
<body>
<h1>6 Limited editor</h1>

<h2><a name="uvod">6.1 Úvod</a></h2>
 
<p>   
Limited editor je aplikace pro editaci map, terénù, herních pøekáek a dalších nastavení pro hru Unlimited Racer. Editor je okenní aplikace pro Windows naprogramována v C++ pomocí Microsoft Visual Studia 2005. Editor pouívá knihovny WIN32 API, MFC a nìkteré funkce z <a href="others.html#ResourceManager">Resource Manageru</a>. Aplikace je psaná v architektuøe dokument/pohled.  
</p>
        <p class="center"><img src="images/editorclassdiagram.gif"></p>
        <p class="center"><strong>Obrázek 6.1: Základní model tøíd editoru.</strong></p>


<h2><a name="dokument">6.2 Dokument - data a jejich správa</a></h2>
    
<p>
Objekt CMapEditorDoc obsahuje data pro editor. Stará se o jejich úpravu, naètení a uloení. Souèástí jsou také informace o aktuální nastavení a stavu editoru.   
</p> 
    
<div class=padleft>
    <h3><a name="objekty">6.2.1 Objekty</a></h3>
        
        <p>Jednotlivé objekty, které se vkládají do mapy jsou uloeny v poli ukazatelù na CMainObject indexovaném názvem souboru <a href="FileSystem.html#Object">*.object</a>. Objekty se primárnì naèítají za pomoci resource manageru pøi nahrávání stromu objektù. Sekundárnì se pøidávají z naètené mapy nebo mùou bıt pøidány uivatelem. Pøi prvním naètení objektu se vytvoøí 2 masky pro danı objekt. První maska zobrazuje obsazení jednotlivıch políèek modely a texturami. Druhá maska zobrazuje políèka, na kterıch je tráva.Také se zkontroluje, zda objekt má ikonu, pokud ikonu nemá, je mu vygenerovaná ikona obsahující stejná èísla, která urèují poøadí objektu bez ikony.Èíslo se zobrazí na kadém políèku objektu, které je obsazeno texturou nebo modelem.</p>    
    
    <h3><a name="mapa">6.2.2 Mapa</a></h3>
        
        <p>Objekt CGameMap obsahuje data a metody tıkající se mapy a terénu.         Místa uloení objektù v mapì a nastavení mapy se naèítá za pomoci resource manageru ze souboru <a href="FileSystem.html#Urmap">*.urmap</a>. Tento soubor také obsahuje jméno souboru s pøíslušnım terénem, kterı se naèítá z <a href="FileSystem.html#Terrain">*.terrain</a>.</p> 
        <div class=padleft>
        <h4><a name="teraobj">6.2.2.1 Terén a objekty v mapì</a></h4>
        
            <p>Samotná mapa a terén je uloena jako pole objektù typu CMapObject. Kadı CMapObject obsahuje pøedevším objekt, kterı je poloen na daném políèku a informace o vıšce terénu.</p>   
             
            <p>Pøi ukládání terénu je potøeba zjistit, jaké terénní pláty jsou na jednotlivıch políèkách. Odlišujeme následující pláty: roh kopce, vnitøní roh kopce a stìna kopce. Aby pøechody u kopcù nebyly ostré, všechny pláty se ještì dìlí na pláty: plát vıšky 1, pata kopce, vršek kopce a støed kopce.  Kadı tento plát mùe mít rùzného souseda a tak jsou ještì rozdìleny, dle typù jejich hran. Pláty jsou vygenerované pomocí <a href="others.html#TerrainGenerator">Terrain Generatoru</a>.  
            </p>
            <dl>
            <dt><strong>Algoritmus pro umístìní plátu:</strong><dt>
               <dl>
               <dt>1. Prochází se mapa a okolí políèek a zjišuje se, zda na daném políèku se nenachází:</dt>
               <dd> I. Roh kopce. </dd>
                <dd>II. Stìna kopce.</dd>
                <dd>III. Vnitøní roh kopce.</dd>
               
              
            <dt>Pokud se nenachází na testovaném místì ádnı z pøedchozím plátù, tak na políèku je rovina. Test urèí i zda je plát vrchní, spodní, stìna, èi vıšky 1. Takto vytvoøené kopce mùou mít v jistıch situacích díry mezi sebou,proto ještì následující krok.</dt>
            <dt>2. Projdu mapu ještì 4x a upravuji jednotlivé typy plátù podle jejich sousedù. Pláty upravuji v poøadí støední pláty,vrchní pláty,spodní pláty a nakonec pláty vıšky 1. Díky tomuto poøadí jsou kopce více zakulacené.  </dt>
                </dl>
            </dl>
            <p>
            Pro kadé políèko terénu se také uloí textura s náhodnou orientací, textury jsou definovaná v souboru <a href="FileSystem.html#Textset">*.Textset</a>. Pokud je v souboru definováno více textur, textury jsou rozmisovány náhodnì, dle pravdìpodobností uloenıch té v souboru textureset. Podle umístìnıch objektù a vygenerované masky pro danı objekt se nastaví pøítomnost trávy na dané políèko.
            </p>
        <h4><a name="zavtrat">6.2.2.2 Závodní tra</a></h4>
        <p>Závodní tra je uloena jako seznam lineárních spojovıch seznamù objektù (CMapMainObject) umístìnıch v mapì. Pokud cesta nebyla editovaná uivatelem, vdy se pøi uloení pokusí map editor najít nejvhodnìjší cestu.</p> 
        <p><b>Algoritmus hledání závodní tratì:</b><br>
           <ol>
            <li>Zjistí zda ve smìru od startovní pozice není objekt s waypointy
            <li> Vybere danı objekt na políèku pokud:<br>
                a) V okolí posledního waypointu je jeden nejbliší waypoint. Okolí má velikosti pùlky políèka.<br>
                b) Objekt ještì nebyl vybrán.  
            <li> Najde konec vybrané cesty, vybere okolní políèka a pokraèuje v bodu 2., dokud se nezastaví. 
           </ol> 
            
       <h4><a name="ostnastmap">6.2.2.3 Ostatní nastavení mapy</a></h4>
            <p>Pro mapu se ukládají další nastavení jako je skysystem, standardní èas mapy, velikost mapy,barva ambientního svìtla v mapì, startovní pozice atd. Startovní pozice je speciální objekt v mapì. Do souboru se ukládá jako odkaz na soubor *.object (objekt obsahuje klíè startingposition=1), jeho otoèení a pozice v mapì. V mapì startovní pozice musí bıt poloena, jinak editor nedovolí mapu uloit. Od startovní pozice se automaticky dopoèítává závodní tra (pokud nebyla definována uivatelem), jestlie se nepodaøí zjistit ani jeden objekt ze závodního okruhu, editor nedovolí mapu uloit a vyzve uivatele k ruènímu nastavení okruhu.</p> 

    </div>
    
    <h3><a name="stromobj">6.2.4 Strom objektù</a></h3>
        <p>
        Strom objektù uchovává seznam všech objektù pouitelnıch v mapeditoru. Strom je odvozenı od MFC tøídy CTreeCtrl a je souèástí objektu CEditorTree, kterı obsahuje funkce pro naètení, uloení stromu a práci se stromem. Struktura stromu je uloená v souboru <a href="FileSystem.html#Objects.tree">objects.tree</a>. Strom se naèítá pøi spuštìní aplikace. Pokud pøi naèítání objekt neexistuje, nebude do stromu pøidán. Pøi naèítání mapy se objekty, které nejsou ve stromì obsaeny a jsou obsaeny v mapì, pøidají do stromu. 
        </p>
                    
            
    <h3><a name="aktobj">6.2.5 Aktuální objekt a editaèní módy</a></h3>
        
        <p>CMapEditorDoc také ukládá aktuální objekt a jeho vlastnosti (rotaci pozici v mapì). Objekt se vybírá ze stromu objektù,èi pøímo z mapy. Objektu obsahuje taky v jakém editaèním stavu se editor nachází a informace o zmìnách, které byly provedeny.</p> 
</div>
        
<h2><a name="pohled">6.3 Pohled - zobrazení datovıch struktur</a></h2>
    <p>Editor je rozloen do nìkolika pohledù. Kadı pohled zobrazuje data z (CMapEditorDoc) a umoòuje práci s nimi.</p>       
<div class=padleft>
    <h3><a name="pictureview">6.3.1 Pohled na vybranı objekt</a></h3>
         
<p>Pohled zobrazuje ikonu objektu, kterı je vybrán ve stromì objektù. Pohled obsahuje 2 tlaèítka, které slouí k otáèení objektu. Na ikonu jsou dokresleny modrou èárou jeho waypointy.</p> 

    <h3><a name="mapview">6.3.2 Pohled na mapu</a></h3>
        <p>Map view zobrazuje pohled na mapu. Protoe mapa je vìtší ne samotnı pohled, jsou pouity posuvníky. Mapa se vykreslí nejdøíve do bufferu o velikosti vıøezu mapy, kterı je zrovna zobrazen. Pak je celı buffer okopírovanı na obrazovku. </p>
    <div class=padleft>
        <h4><a name="zobrter">6.3.2.1 Zobrazení terénu.</a></h4>
            <p>Terén je zobrazen odstíny zelené barvy. Vyšší vıškovı stupeò je svìtlejší. Pøi spuštìní map editoru se vygenerují bitmapy, které zobrazují pøechody mezi jednotlivımi vıškovımi stupni (stìna kopce, roh kopce). Bitmapa je ètvercová a kadému vrcholu ètverce je na základì vıšky vedlejšího políèka pøiøazena barva. Políèko je pak vygenerováno pomocí cosinové interpolace (obr. 6.2). Pøi vykreslení mapy se zkontroluje okolí políèka a na základì okolních vıškovıch stupòù se vybere a otoèí správná bitmapa.</p>
    <p class="center"><img src="images/terrain.gif"></p>
    <p class="center"><strong>Obrázek 6.2: Kopec vıšky jedna. Èísla zobrazují uloené vıškové stupnì políèek.</strong></p>        
            
        <h4><a name="zobrobjmap">6.3.2.2 Zobrazení objektù v mapì.</a></h4>
            <p>Objekt v mapì je zobrazen jako ikona. Jméno souboru s ikonou je uloen v souboru <a href="FileSystem.html#Object">*.object</a>. Ikona je zmenšená, èi zvìtšená do velikosti objektu pro zobrazení do mapy. Transparentní barva ikony má hodnotu #FA36C5. Na ikonu jsou modrou èarou zobrazeny jednotlivé cesty tvoøené waypointy.    </p>
            
        <h4><a name="zobrzavtrat">6.3.2.3 Zobrazení závodní trati.</a></h4>
        <p> 
            Mainobjekty, které leí na trati jsou zvıraznìny modrou barvou. Kadı zaèátek spojité cesty je oznaèen èíslem.</p> 
    </div>
    <h3><a name="treeview">6.3.3 Tree view</a></h3>
    
        <p>Pohled zobrazuje strom objektù, které mùou bıt pøidány do mapy. Strom je sloen z uzlù (skupina objektù) a z listù(jednotlivé objekty). Pohled na strom je odvozenı od tøídy CTreeView, která je souèástí MFC.  </p>
    
    <h3><a name="dialogy">6.3.4 Dialogy</a></h3>
        
        Editor obsahuje 3 dialogy. 
            <ol>
            <li> Dialog pro novou hru, kterı se objeví pøi spuštìní nové mapy, kde se nastavuje velikost mapy a její jméno. 
            <li> Dialog s nastavením vlastnosti mapy, kde se nastavuje jméno mapy, èas, textury zdi, textury terénu, fyzikální textury, typ trávy a zvolenı skysystem. 
            <li> Dialog je urèenı pro editování konfiguraèních souborù. Ve vrchním oknì je uloena nápovìda, která je uloena v souboru typsouboru.rtf. V pravém sloupci je list klíèù. Spodní okno je editaèní.      
            </ol>
</div>
<h2><a name="editdat">6.4 Editace</a></h2>
<div class=padleft>
    <h3><a name="editter">6.4.1 Editace terenu</a></h3>
        <p>Terén je matice políèek, která obsahuje jednotlivé vıšky. Terén se edituje zvyšováním nebo sniováním jednotlivıch políèek. Protoe celı terén se skládá z vygenerovanıch plátù, tak rozloení vıšek terénu nemùe bıt libovolné a musí se øídit následujícími pravidly:</p>
        <ul>
        <li>a) Kadé sousední políèko (sousední i pøes diagonálu) mùe bıt maximálnì o 1 vyšší nebo niší.
               <p class="center"><img src="images/terrainhill.gif"></p>  
               <p class="center"><strong>Obrázek 6.3: Situace porušující pravidlo a jejich vyøešení pøi zvyšování terénu (èíslo zobrazuje vıšku políèka):</strong></p>
        <li>b) Mezi kadımi 2 stejnì vysokımi políèky vzdálenıch od sebe 1 políèko musí existovat políèko stejné nebo vyšší vıšky. 
        </ul>
 
        <p class="center"><img src="images/terrainhorse.gif"></p>
        <p class="center"><img src="images/terraindiag.gif"></p>
        <p class="center"><img src="images/terrainrow.gif"></p>
<p class="center"><strong>Obrázek 6.4: Situace porušující pravidlo a jejich vyøešení pøi zvyšování terénu (èíslo zobrazuje vıšku políèka):</strong></p>


        <b>Algoritmus zvıšení terénu:</b> 
            <ol>
            <li>Zvıším vybrané políèko
            <li>Otestuji zda v okolí políèka není nìjaké políèko, které odporuje pravidlu a) pokud ano rekurzivnì ho zvıším (obr. 6.3).
            <li>Zkontroluji pravidlo b). Hledám políèko vyšší a nebo stejnì vysoké vzdálené pøes 1 políèko. Pokud je u nìj porušeno pravidlo b) rekurzivnì zvıším políèko mezi nima. Pokud jsou tyto políèka dvì (obr. 6.4) rekurzivnì zvıším pouze jedno.  
            </ol>
        <b>Sníení terénu:</b>
            <ol>
            <li>Sníím vybrané políèko
            <li>Otestuji zda v okolí políèka není nìjaké políèko, které odporuje pravidlu a), pokud ano rekurzivnì ho sníím.
            
	        <li>Hledám zaèátek cesty, po které budu procházet jednotlivá okolní políèka. Cesta má tvar viz obr. 6.5. Mùe zaèínat na 4 pøilehlıch políèkách (podle otoèení cesty). Cesta zaèíná na políèku s nejniší vıškou.
	        <li> Vybranı políèko z cesty sníím a pokusím se ho zvednout(zavolám algoritmus pro zvıšení terénu), pokud zvednutím zvedne i políèko, které u bylo sníeno nechám ho sníené, jinak vrátím.
             
	        <li>Ukládám políèka z cesty ke sníení a pak na nì zavolám rekurzivnì sníení.
	        </ol>
          <p class="center"><img src="images/terrainpath.gif"></p>
          <p class="center"><strong>Obrázek 6.5: Èísla zobrazují jedno z monıch poøadí, v kterém jsou vybírána jednotlivá pole ke sníení.</strong></p>
    <h3><a name="editmap">6.4.2 Vkládání objektù do mapy</a></h3>
        <p>Kadı objekt má uloenou masku, která ukazuje, kde jsou poloeny objekty a textury.Na kadım místì v mapì mùe bıt umístìní pouze jeden model nebo textura.
        </p>   
        
    <h3><a name="editces">6.4.3 Editace závodní tratì</a></h3>
        <p>
        Uivatel má monost nadefinovat si vlastní závodní tra. Tra se edituje v race course edit modu. Vdy kdy klikne na nìjakı objekt v mapì editor se pokusí najít co nejdelší spojitou cestu od místa, kde je object umístìn. Viz algoritmus v kapitole 2.2.2. Pokud mu nevyhovuje tato cesta mùe kliknutím na objekt odmazat cestu a k tomuto objektu. Cesta mùe vést pouze pøes objekty s waypointy. 
        </p>
    
    <h3><a name="editstr">6.4.4 Editace stromu</a></h3>
        <p>Strom se edituje pøes kontextové menu, které se objeví po stisknutí pravého tlaèítka. Ve stromu se dají vytváøet nové objekty mùou se vyjímat a vkládat celé vìtve. Pokud se pøidá nová poloka do stromu, tak se mu mùou pøidat potomci - stane se uzlem a nebo se k nìmu pøiøadí nìjakı soubor *.object a v tom pøípadì se stane listem a objektem, kterı lze umístit do mapy. 
    
    <h3><a name="editkon">6.4.5 Editace konfiguraèních souboru</a></h3>
        <p>Editor obsahuje pomocnı nástroj pro editaci souborù. Dialog obsahuje 2 pomocná okna viz. 3.4.3 Obsah pravého okna je uloen v souboru *.dlghlp. Pøi poklepání se vloí text, kterı je definován v souboru pod danım návìštím(øádek zaèínající --). Pokud øádek obsahuje %%typ, vyvolá dialog naèítací dialog pro danı typ a vrátí do editu jméno vybrané poloky.</p> 
        
</div>
        
        
    


</body>
